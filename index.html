<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EIA Crush - Energy in Action</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            touch-action: none; /* Impede gestos do browser como puxar para atualizar */
            overscroll-behavior: none;
        }
        .game-board {
            display: grid;
            border: 4px solid #4a5568;
            background-color: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(5px);
            padding: 8px;
            gap: 4px;
        }
        .gem {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            background: radial-gradient(circle, #6b7280, #374151);
            border-radius: 20%;
            box-shadow:
                inset 0 4px 6px rgba(255, 255, 255, 0.2), /* Brilho superior interno */
                inset 0 -4px 6px rgba(0, 0, 0, 0.3),   /* Sombra inferior interna */
                0 5px 10px rgba(0, 0, 0, 0.5);       /* Sombra projetada no tabuleiro */
        }
        .gem svg {
            width: 65%;
            height: 65%;
            filter: drop-shadow(0 2px 2px rgba(0,0,0,0.5));
            pointer-events: none; /* Garante que o clique vai para o div .gem */
        }
        .gem.is-selected {
            transform: scale(1.1);
            box-shadow:
                inset 0 4px 6px rgba(255, 255, 255, 0.2),
                inset 0 -4px 6px rgba(0, 0, 0, 0.3),
                0 5px 10px rgba(0, 0, 0, 0.5),
                0 0 0 4px white;
        }
        .gem.is-locked::after {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><path d="M25,50 L75,50 M50,25 L50,75" stroke="%23FFFFFF" stroke-width="10" stroke-linecap="round" transform="rotate(45 50 50)"/></svg>');
            background-size: 60%;
            background-repeat: no-repeat;
            background-position: center;
            opacity: 0.7;
        }
        .hole {
            background: transparent;
            box-shadow: none;
            border: none;
        }
        /* Estilos para Super √çcones */
        .gem.super-striped-h::after, .gem.super-striped-v::after {
            content: '';
            position: absolute;
            top: 10%; bottom: 10%; left: 10%; right: 10%;
            border-radius: 50%;
            background: repeating-linear-gradient(
                45deg,
                rgba(255,255,255,0.3),
                rgba(255,255,255,0.3) 10px,
                rgba(255,255,255,0) 10px,
                rgba(255,255,255,0) 20px
            );
            animation: pulse-light 1.5s infinite;
        }
        .gem.super-striped-v::after {
             background: repeating-linear-gradient(
                -45deg,
                rgba(255,255,255,0.3),
                rgba(255,255,255,0.3) 10px,
                rgba(255,255,255,0) 10px,
                rgba(255,255,255,0) 20px
            );
        }
        .gem.super-wrapped::before {
            content: '';
            position: absolute;
            top: 5%; bottom: 5%; left: 5%; right: 5%;
            border: 4px solid white;
            border-radius: 50%;
            animation: pulse-light 1.2s infinite ease-in-out;
        }
        .gem.super-color-bomb svg {
            animation: color-bomb-spin 5s linear infinite;
        }
        @keyframes color-bomb-spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        @keyframes pulse-light {
            0% { box-shadow: 0 0 5px #fff, 0 0 10px #fff; }
            50% { box-shadow: 0 0 20px #fff, 0 0 30px #fff; }
            100% { box-shadow: 0 0 5px #fff, 0 0 10px #fff; }
        }
        .gem.is-exploding {
            animation: explode 0.5s forwards;
        }
        @keyframes explode {
            0% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(0); opacity: 0; }
        }
        .modal {
            display: none; /* Escondido por defeito */
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            animation: slide-down 0.5s ease-out;
        }
        @keyframes slide-down {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 200;
            padding: 1rem 2rem;
            border-radius: 1rem;
            color: white;
            font-size: 2rem;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            animation: fade-in-out 2s forwards;
        }
        @keyframes fade-in-out {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
            20% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            80% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -80%) scale(0.5); }
        }
        .low-time, .low-moves {
            animation: flash-red 1s infinite;
        }
        @keyframes flash-red {
            0%, 100% { color: white; transform: scale(1); }
            50% { color: #ef4444; transform: scale(1.1); }
        }

        .objective-near-complete {
            animation: flash-green 1s infinite;
        }

        @keyframes flash-green {
            0%, 100% { transform: scale(1); color: white; }
            50% { transform: scale(1.05); color: #86efac; }
        }
        .hint {
            animation: hint-pulse 1s infinite;
        }
        @keyframes hint-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.08); }
        }
        .point-popup {
            position: absolute;
            font-size: 2rem;
            font-weight: bold;
            color: #facc15;
            text-shadow: 2px 2px 4px black;
            pointer-events: none;
            animation: float-up 1s forwards;
        }
        .point-popup.special {
            font-size: 3rem;
            color: #ec4899;
        }
        @keyframes float-up {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-60px); opacity: 0; }
        }
        .particle {
            position: absolute;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            pointer-events: none;
            z-index: 20;
            animation: particle-anim 0.7s forwards;
        }
        @keyframes particle-anim {
            0% {
                transform: scale(1);
                opacity: 1;
            }
            100% {
                transform: scale(0);
                opacity: 0;
            }
        }
        @keyframes shake {
            0%, 100% { transform: translate(0, 0) rotate(0); }
            25% { transform: translate(5px, 2px) rotate(-1deg); }
            50% { transform: translate(-5px, -2px) rotate(1deg); }
            75% { transform: translate(5px, 2px) rotate(-1deg); }
        }
        .gem-fall {
            transition: top 0.3s cubic-bezier(0.6, -0.28, 0.735, 0.045); /* easeInBack */
        }
        .gem-entering {
            animation: gem-bounce 0.5s ease-out;
        }
        @keyframes gem-bounce {
            0% { transform: scale(0.5); opacity: 0; }
            60% { transform: scale(1.1); opacity: 1; }
            80% { transform: scale(0.9); }
            100% { transform: scale(1); }
        }
        .super-gem-creation {
            animation: new-super-gem 0.6s ease-in-out;
        }
        @keyframes new-super-gem {
            0% { transform: scale(1); }
            50% { transform: scale(1.4) rotate(15deg); box-shadow: 0 0 20px 10px #fef08a; }
            100% { transform: scale(1) rotate(0); }
        }
        .gem-swap {
            transition: top 0.3s ease-out, left 0.3s ease-out;
        }
        .jelly {
            position: absolute;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.3);
            border-radius: 20%;
            pointer-events: none;
            z-index: -1;
        }
        .ice {
            position: absolute;
            width: 100%;
            height: 100%;
            background-color: rgba(173, 216, 230, 0.5);
            border: 2px solid #add8e6;
            border-radius: 20%;
            pointer-events: none;
            z-index: 1;
        }
        .chains {
            position: absolute;
            width: 100%;
            height: 100%;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><line x1="0" y1="0" x2="100" y2="100" stroke="gray" stroke-width="10"/><line x1="0" y1="100" x2="100" y2="0" stroke="gray" stroke-width="10"/></svg>');
            background-size: 80%;
            background-repeat: no-repeat;
            background-position: center;
            pointer-events: none;
            z-index: 2;
        }
        /* Mapa de N√≠veis */
        .level-node {
            width: 50px; height: 50px;
            border: 4px solid #9ca3af;
            background-color: #4b5563;
            cursor: pointer;
        }
        .level-node.unlocked {
            background-color: #a855f7;
            border-color: #c4b5fd;
            animation: pulse-level 2s infinite;
        }
        @keyframes pulse-level {
            0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(196, 181, 253, 0.7); }
            50% { transform: scale(1.05); box-shadow: 0 0 10px 10px rgba(196, 181, 253, 0); }
        }
        .level-node.completed {
            background-color: #16a34a;
            border-color: #86efac;
        }
        .world-tab {
            transition: all 0.3s ease;
        }
        .world-tab.active {
            background-color: #a855f7;
            color: white;
            transform: translateY(-2px);
        }

        .sugar-crush-active {
            animation: sugar-crush-pulse 0.8s infinite ease-in-out;
        }
        @keyframes sugar-crush-pulse {
            0%, 100% { box-shadow: inset 0 0 0 0 rgba(255, 255, 150, 0); }
            50% { box-shadow: inset 0 0 30px 15px rgba(255, 255, 150, 0.4); }
        }

        .screen-shake {
            animation: shake-hard 0.4s;
        }

        @keyframes shake-hard {
            0%, 100% { transform: translateX(0); }
            20% { transform: translateX(-10px); }
            40% { transform: translateX(10px); }
            60% { transform: translateX(-10px); }
            80% { transform: translateX(10px); }
        }

        /* Anima√ß√µes de Combo */
        .board-clear-ripple {
            position: absolute;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.5);
            animation: ripple-out 0.7s forwards;
        }
        .shockwave {
            position: absolute;
            border-radius: 50%;
            border: 5px solid white;
            pointer-events: none;
            z-index: 15;
            animation: shockwave-anim 0.4s forwards;
        }
        @keyframes shockwave-anim {
            0% {
                transform: scale(0);
                opacity: 1;
            }
            100% {
                transform: scale(2.5);
                opacity: 0;
            }
        }
        @keyframes ripple-out {
            from {
                width: 0%;
                height: 0%;
                opacity: 1;
            }
            to {
                width: 200%;
                height: 200%;
                opacity: 0;
            }
        }

        /* Anima√ß√µes de Feedback de Obst√°culos/Objetivos */
        .ice-shatter::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><path d="M20 20 L80 80 M20 80 L80 20" stroke-width="5" stroke="white" stroke-linecap="round" /></svg>');
            animation: shatter-anim 0.4s forwards;
        }
        @keyframes shatter-anim {
            0% { transform: scale(0.5); opacity: 1; }
            100% { transform: scale(1.5); opacity: 0; }
        }

        .chain-break::after {
            content: '‚õì';
            position: absolute;
            font-size: 2rem;
            color: #9ca3af;
            animation: chain-break-anim 0.5s forwards;
        }
        @keyframes chain-break-anim {
            0% { transform: scale(1) rotate(0); opacity: 1; }
            100% { transform: scale(0.5) rotate(360deg); opacity: 0; }
        }

        .jelly-splat::before {
            content: '';
            position: absolute;
            top: 10%; left: 10%; right: 10%; bottom: 10%;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            animation: splat-anim 0.3s forwards;
        }
        @keyframes splat-anim {
            from { transform: scale(0); }
            to { transform: scale(1.5); opacity: 0; }
        }

        .collect-fly {
            position: fixed; /* Para voar sobre tudo */
            z-index: 200;
            transition: top 0.5s ease-in, left 0.5s ease-in, transform 0.5s ease-in;
        }
    </style>
</head>
<body class="bg-gray-800 text-white overflow-hidden h-screen">

    <div id="app" class="h-full w-full">
        <!-- O JOGO SER√Å RENDERIZADO AQUI -->
    </div>

    <audio id="music-player" loop></audio>
    <button id="mute-btn" class="fixed bottom-4 right-4 z-50 bg-purple-600 hover:bg-purple-700 text-white font-bold p-3 rounded-full shadow-lg transition-transform transform hover:scale-110">
        <svg id="speaker-icon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"></path></svg>
        <svg id="muted-speaker-icon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" clip-rule="evenodd"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 14l2-2m0 0l2-2m-2 2l-2 2m2-2l2 2"></path></svg>
    </button>

    <!-- Templates para os ecr√£s do jogo -->
    <template id="main-menu-template">
        <div class="flex flex-col items-center justify-center h-full bg-gray-900 p-4">
            <h1 class="text-6xl font-bold text-yellow-400 mb-2" style="text-shadow: 3px 3px 0 #92400e;">EIA Crush</h1>
            <p class="text-xl text-gray-300 mb-8">Energy in Action</p>
            <div id="auth-buttons" class="flex flex-col gap-4">
                 <button id="login-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-4 px-10 rounded-full text-2xl transition-transform transform hover:scale-105 shadow-lg">Login</button>
                 <button id="register-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-10 rounded-full text-2xl transition-transform transform hover:scale-105 shadow-lg">Registar</button>
                 <button id="guest-play-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-8 rounded-full text-xl transition-transform transform hover:scale-105 shadow-lg">Jogar como Convidado</button>
            </div>
            <div id="user-info" class="hidden text-center">
                <p class="text-2xl mb-4">Bem-vindo, <span id="username-display"></span>!</p>
                <button id="play-map-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-4 px-10 rounded-full text-2xl transition-transform transform hover:scale-105 shadow-lg">
                    Jogar
                </button>
                <div class="mt-8 text-lg">Vidas: <span id="menu-lives-display" class="font-bold">5</span></div>
                <div class="mt-4 text-lg">Pontua√ß√£o Total: <span id="menu-total-score-display" class="font-bold">0</span></div>
            </div>
            <div class="flex flex-wrap gap-4 mt-6 justify-center">
                 <button id="history-btn" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-6 rounded-full text-lg">Hist√≥ria da EIA</button>
                 <button id="glossary-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-full text-lg">Gloss√°rio de Energia</button>
                 <button id="hall-of-fame-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-full text-lg">Hall of Fame</button>
            </div>
            <div class="flex space-x-6 mt-8">
                <a href="https://www.tiktok.com/@koelho2000" target="_blank" class="text-gray-400 hover:text-white transition-transform transform hover:scale-110">
                    <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path d="M12.525.02c1.31-.02 2.61-.01 3.91-.02.08 1.53.63 3.09 1.75 4.17 1.12 1.11 2.7 1.62 4.24 1.79v4.03c-1.44-.05-2.89-.35-4.2-.97-.57-.26-1.1-.59-1.62-.93-.01 2.92.01 5.84-.02 8.75-.08 1.4-.54 2.79-1.35 3.94-1.31 1.92-3.58 3.17-5.91 3.21-2.43.05-4.85-.98-6.46-2.9-1.6-1.92-2.3-4.41-2.06-6.93.24-2.52 1.86-4.86 4.03-5.9 2.17-1.04 4.66-.98 6.78.15.01-.01.01-.02.01-.03.01-2.2 0-4.4-.01-6.6.01-1.21-.43-2.37-1.12-3.32C11.37 1.42 10.11.41 8.7.11c-.02.01-.02.01-.03.01.01-.01.01-.01.02-.01z"/></svg>
                </a>
                <a href="https://www.instagram.com/eia_energyinaction/" target="_blank" class="text-gray-400 hover:text-white transition-transform transform hover:scale-110">
                    <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M12 2.25c-2.455 0-2.755.01-3.71.054-1.44.065-2.387.31-3.227.643-.913.35-1.64.78-2.366 1.507-.725.726-1.156 1.452-1.507 2.366-.333.84-.578 1.787-.643 3.227-.044.955-.054 1.255-.054 3.71s.01 2.755.054 3.71c.065 1.44.31 2.387.643 3.227.35.913.782 1.64 1.507 2.366.726.725 1.452 1.156 2.366 1.507.84.333 1.787.578 3.227.643.955.044 1.255.054 3.71.054s2.755-.01 3.71-.054c1.44-.065 2.387-.31 3.227-.643.913-.35 1.64-.782 2.366-1.507.725-.726 1.156-1.452 1.507-2.366.333-.84.578-1.787-.643-3.227.044-.955.054-1.255.054-3.71s-.01-2.755-.054-3.71c-.065-1.44-.31-2.387-.643-3.227-.35-.913-.78-1.64-1.507-2.366-.726-.725-1.452-1.156-2.366-1.507-.84-.333-1.787-.578-3.227-.643C14.755 2.26 14.455 2.25 12 2.25zm0 1.8a8.949 8.949 0 00-3.638.052c-1.21.054-1.92.27-2.48.473-.616.22-.98.44-1.32.78-.34.34-.56.704-.78 1.32-.203.56-.419 1.27-.473 2.48A8.949 8.949 0 004.05 12c0 2.41.01 2.71.052 3.638.054 1.21.27 1.92.473 2.48.22.616.44.98.78 1.32.34.34.704.56 1.32.78.56.203 1.27.419 2.48.473A8.949 8.949 0 0012 19.95c2.41 0 2.71-.01 3.638-.052 1.21-.054 1.92-.27 2.48-.473.616-.22-.98-.44 1.32-.78.34.34.56-.704-.78-1.32.203-.56.419-1.27.473-2.48A8.949 8.949 0 0019.95 12c0-2.41-.01-2.71-.052-3.638-.054-1.21-.27-1.92-.473-2.48-.22-.616-.44-.98-.78-1.32-.34-.34-.704-.56-1.32-.78-.56-.203-1.27-.419-2.48-.473A8.949 8.949 0 0012 4.05zm0 3.6a4.35 4.35 0 100 8.7 4.35 4.35 0 000-8.7zm0 1.8a2.55 2.55 0 110 5.1 2.55 2.55 0 010-5.1zM16.5 6.3a1.2 1.2 0 11-2.4 0 1.2 1.2 0 012.4 0z" clip-rule="evenodd"/></svg>
                </a>
                <a href="https://youtube.com/playlist?list=PLHHMjSyJQeBCFjuuPaqrhqMic374sFIkG&si=GimZ3c0V-wMgoMSo" target="_blank" class="text-gray-400 hover:text-white transition-transform transform hover:scale-110">
                    <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path d="M19.615 3.184c-3.604-.246-11.631-.245-15.23 0-3.897.266-4.356 2.62-4.385 8.816.029 6.185.484 8.549 4.385 8.816 3.6.245 11.626.246 15.23 0 3.897-.266 4.356-2.62 4.385-8.816-.029-6.185-.484-8.549-4.385-8.816zm-10.615 12.823v-7.04l6.02 3.52-6.02 3.52z"/></svg>
                </a>
            </div>
             <a href="https://www.eia.pt" target="_blank" class="absolute bottom-8 text-center text-gray-400 text-sm hover:text-white">www.eia.pt</a>
             <p class="absolute bottom-2 text-center text-gray-500 text-xs">Original idea by Jos√© Coelho - koelho2000</p>
        </div>
    </template>

    <template id="world-map-template">
        <div class="flex flex-col items-center justify-center h-full bg-gray-900 p-4">
            <div class="flex items-center justify-center w-full max-w-md relative mb-2">
                 <h2 class="text-4xl font-bold">Mapa de Mundos</h2>
                 <button id="world-help-btn" class="absolute right-0 text-white bg-blue-500 hover:bg-blue-600 rounded-full w-10 h-10 flex items-center justify-center font-bold text-2xl">?</button>
            </div>
             <div class="text-center mb-4">
                <div class="text-xl font-bold">Pontua√ß√£o Total: <span id="map-total-score-display">0</span></div>
                <div class="text-lg font-bold mt-1 flex items-center justify-center">
                    <svg class="w-6 h-6 mr-2 text-yellow-400" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-5.5a1 1 0 11-2 0v-1a1 1 0 112 0v1zM10 6a1 1 0 011 1v3a1 1 0 11-2 0V7a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                    Moedas de Energia: <span id="map-energy-coins-display">0</span>
                </div>
            </div>
            <div id="world-tabs" class="flex flex-wrap justify-center gap-2 mb-4">
                <!-- Tabs dos mundos ser√£o inseridas aqui -->
            </div>
            <div id="level-grid" class="grid grid-cols-5 gap-4 p-4 bg-gray-800 rounded-lg w-full max-w-md h-64 overflow-y-auto">
                <!-- Os n√≥s dos n√≠veis ser√£o inseridos aqui -->
            </div>
            <div id="final-level-container" class="mt-4"></div>
            <div class="flex gap-4 mt-6">
                <button id="back-to-main-menu-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-full text-lg">Menu Principal</button>
                <button id="unlock-btn" class="bg-yellow-600 hover:bg-yellow-700 text-black font-bold py-2 px-6 rounded-full text-lg">Desbloquear</button>
                <button id="logout-btn" class="hidden bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-full text-lg">Logout</button>
            </div>
        </div>
    </template>

    <template id="game-screen-template">
         <div id="game-container" class="flex flex-col items-center justify-center h-full w-full p-2 sm:p-4 transition-colors duration-1000">
            <!-- Total Score Bar -->
            <div class="w-full max-w-lg bg-yellow-500 text-black p-1 text-center rounded-t-xl shadow-md">
                <span class="text-sm font-bold">PONTUA√á√ÉO TOTAL: </span>
                <span id="game-total-score-display" class="text-lg font-bold">0</span>
            </div>
            <!-- Header -->
            <div class="w-full max-w-lg bg-black bg-opacity-30 p-2 flex justify-between items-center">
                <div class="text-center">
                    <div class="text-sm opacity-80">N√≠vel</div>
                    <div id="game-level-display" class="text-2xl font-bold">1</div>
                </div>
                 <div class="text-center">
                    <div class="text-sm opacity-80">Her√≥i</div>
                    <div id="game-character-display" class="text-xl font-semibold">Sunny</div>
                </div>
                <div class="text-center">
                    <div class="text-sm opacity-80">Vidas</div>
                    <div id="game-lives-display" class="text-2xl font-bold">3</div>
                </div>
                 <button id="help-btn" class="text-white bg-blue-500 hover:bg-blue-600 rounded-full w-8 h-8 flex items-center justify-center font-bold text-xl">?</button>
            </div>
            <!-- Boosters In-Game -->
            <div id="ingame-boosters" class="w-full max-w-lg flex justify-end p-1 gap-2">
                <button id="gem-hammer-booster" class="hidden bg-yellow-500 hover:bg-yellow-600 text-black font-bold p-2 rounded-lg shadow-md">üî®</button>
            </div>
            <!-- Game Board -->
            <div id="game-board-container" class="w-full max-w-lg aspect-square p-2 relative">
                <div id="animation-layer" class="absolute inset-0 pointer-events-none z-10"></div>
                <div id="game-board" class="game-board w-full h-full rounded-lg"></div>
            </div>
            <!-- Footer -->
            <div class="w-full max-w-lg bg-black bg-opacity-30 p-2 rounded-b-xl grid grid-cols-3 gap-2 text-center">
                <div>
                    <div class="text-sm opacity-80">Pontos</div>
                    <div id="game-score-display" class="text-2xl font-bold">0</div>
                </div>
                <div id="objective-display">
                     <div class="text-sm opacity-80">Objetivo</div>
                     <div id="game-target-display" class="text-2xl font-bold">5000</div>
                </div>
                <div id="moves-or-time-display">
                    <div class="text-sm opacity-80">Jogadas</div>
                    <div id="game-moves-display" class="text-2xl font-bold">30</div>
                </div>
            </div>
             <button id="quit-level-btn" class="mt-4 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-full text-sm">
                Sair do N√≠vel
            </button>
        </div>
    </template>


    <!-- Modal de In√≠cio de N√≠vel -->
    <div id="level-start-modal" class="modal">
        <div class="modal-content bg-gray-800 p-8 rounded-2xl shadow-2xl text-center max-w-sm mx-4">
            <img id="start-char-img" src="https://placehold.co/150x150/f59e0b/ffffff?text=S" class="mx-auto mb-4 rounded-full border-4 border-yellow-400">
            <h2 class="text-3xl font-bold mb-2">N√≠vel <span id="start-level">1</span></h2>
            <p class="text-lg mb-4">Objetivo: <span id="start-target" class="font-bold">500</span> pontos</p>
            <div id="start-modal-extra-info" class="text-lg mb-4"></div>

            <div class="my-4 p-4 bg-gray-900 rounded-lg">
                <h3 class="text-xl font-bold mb-2 text-yellow-400">Boosters</h3>
                <div id="booster-selection" class="flex justify-center gap-4">
                    <!-- Booster buttons will be inserted here by JS -->
                </div>
                <div class="mt-2 text-center text-lg">
                    Moedas de Energia: <span id="booster-energy-coins-display" class="font-bold text-yellow-400">0</span>
                </div>
            </div>

            <button id="start-game-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-8 rounded-full text-xl transition-transform transform hover:scale-105">Jogar</button>
            <a href="https://www.eia.pt" target="_blank" class="block text-center text-gray-400 mt-4 text-sm hover:text-white">www.eia.pt</a>
        </div>
    </div>

    <!-- Modal "Sabia Que?" -->
    <div id="sabia-que-modal" class="modal">
        <div class="modal-content bg-blue-800 p-8 rounded-2xl shadow-2xl text-center max-w-md mx-4">
            <h2 class="text-3xl font-bold mb-4 text-yellow-300">Sabia Que?</h2>
            <p id="sabia-que-fact" class="text-lg mb-6"></p>
            <button id="continue-to-score-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-8 rounded-full text-xl">Continuar</button>
        </div>
    </div>

    <!-- Modal de N√≠vel Conclu√≠do -->
    <div id="level-complete-modal" class="modal">
        <div class="modal-content bg-green-600 p-8 rounded-2xl shadow-2xl text-center max-w-sm mx-4">
            <h2 class="text-4xl font-bold mb-2">N√≠vel Conclu√≠do!</h2>
            <div id="star-display" class="flex justify-center my-4"></div>
            <img id="complete-char-img" src="https://placehold.co/150x150/10b981/ffffff?text=EIA" class="mx-auto mb-4 rounded-full border-4 border-green-300">

            <div id="bonus-points-container" class="text-lg mb-4">
                <p>Pontos do N√≠vel: <span id="level-score-display">0</span></p>
                <p>B√≥nus: <span id="bonus-score-display">0</span></p>
                <hr class="my-2 border-green-300">
                <p class="text-2xl font-bold">Total: <span id="final-score">0</span></p>
            </div>

            <p id="complete-char-message" class="italic text-lg mb-6">"Bom trabalho! Cada ponto √© energia bem aplicada!"</p>
            <button id="next-level-btn" class="bg-white text-green-600 font-bold py-3 px-8 rounded-full text-xl transition-transform transform hover:scale-105">Pr√≥ximo N√≠vel</button>
            <a href="https://www.eia.pt" target="_blank" class="block text-center text-green-100 mt-4 text-sm hover:text-white">www.eia.pt</a>
        </div>
    </div>

    <!-- Modal de Fim de Mundo -->
    <div id="world-complete-modal" class="modal">
        <div class="modal-content bg-gradient-to-br from-blue-600 to-green-500 p-8 rounded-2xl shadow-2xl text-center max-w-lg mx-4">
            <h2 id="world-complete-title" class="text-5xl font-bold mb-4 text-white" style="text-shadow: 2px 2px 4px #000;">Mundo 1 - Sunny Conclu√≠do!</h2>
            <p class="text-xl text-white mb-6">Excelente trabalho! Derrotaste <span id="world-complete-character-name"></span> e trouxeste mais energia limpa ao mundo!</p>

            <div class="bg-black bg-opacity-30 p-4 rounded-lg text-left space-y-2 mb-4">
                <h3 class="text-2xl font-bold text-yellow-300 text-center mb-4">O Teu Resumo</h3>
                <p class="text-lg"><strong>Pontua√ß√£o Total:</strong> <span id="summary-world-total-score" class="font-bold text-white float-right">0</span></p>
                <p class="text-lg"><strong>Horas de Jogo:</strong> <span id="summary-world-play-time" class="font-bold text-white float-right">0</span></p>
                <p class="text-lg"><strong>Super √çcones Criados:</strong> <span id="summary-world-super-icons" class="font-bold text-white float-right">0</span></p>
            </div>

            <div class="bg-black bg-opacity-30 p-4 rounded-lg text-left space-y-2 mb-6">
                <h3 class="text-2xl font-bold text-yellow-300 text-center mb-4">Hall of Fame (Top 3 Pontos)</h3>
                <ol id="hof-comparison-list" class="list-none space-y-2">
                    <!-- Preenchido dinamicamente -->
                </ol>
            </div>

            <button id="continue-to-next-world-btn" class="bg-white text-blue-600 font-bold py-3 px-8 rounded-full text-xl transition-transform transform hover:scale-105">Pr√≥ximo Mundo</button>
        </div>
    </div>

     <!-- Modal de Fim de Jogo (Conclus√£o) -->
    <div id="game-complete-modal" class="modal">
        <div class="modal-content bg-gradient-to-br from-purple-600 to-yellow-500 p-8 rounded-2xl shadow-2xl text-center max-w-lg mx-4">
            <h2 class="text-5xl font-bold mb-4 text-white" style="text-shadow: 2px 2px 4px #000;">Parab√©ns!</h2>
            <p class="text-xl text-white mb-6">Conclu√≠ste a tua jornada EIA Crush e ajudaste a construir um futuro com mais energia!</p>

            <div class="bg-black bg-opacity-30 p-4 rounded-lg text-left space-y-2 mb-6">
                <h3 class="text-2xl font-bold text-yellow-300 text-center mb-4">Resumo Final</h3>
                <p class="text-lg"><strong>Pontua√ß√£o Total:</strong> <span id="summary-total-score" class="font-bold text-white float-right">0</span></p>
                <p class="text-lg"><strong>Horas de Jogo:</strong> <span id="summary-play-time" class="font-bold text-white float-right">0</span></p>
                <p class="text-lg"><strong>Pe√ßas Listadas Criadas:</strong> <span id="summary-striped" class="font-bold text-white float-right">0</span></p>
                <p class="text-lg"><strong>Pe√ßas Embrulhadas Criadas:</strong> <span id="summary-wrapped" class="font-bold text-white float-right">0</span></p>
                <p class="text-lg"><strong>Bombas de Cor Criadas:</strong> <span id="summary-color-bombs" class="font-bold text-white float-right">0</span></p>
            </div>

            <button id="back-to-menu-from-complete-btn" class="bg-white text-purple-600 font-bold py-3 px-8 rounded-full text-xl transition-transform transform hover:scale-105">Voltar ao Menu Principal</button>
        </div>
    </div>

    <!-- Modal de Introdu√ß√£o ao N√≠vel B√≥nus -->
    <div id="bonus-level-modal" class="modal">
        <div class="modal-content bg-yellow-500 p-8 rounded-2xl shadow-2xl text-center max-w-sm mx-4">
            <h2 class="text-4xl font-bold mb-2">N√≠vel B√≥nus!</h2>
             <img id="bonus-char-img" src="https://placehold.co/150x150/f59e0b/ffffff?text=EIA" class="mx-auto mb-4 rounded-full border-4 border-yellow-300">
            <p id="bonus-char-name" class="text-2xl font-semibold mb-4">Super Desafio de Sunny!</p>
            <p id="bonus-char-efficiency-message" class="italic text-lg mb-6">"Use o sol com sabedoria ‚Äî hor√°rios de maior produ√ß√£o fotovoltaica reduzem custos."</p>
            <button id="start-bonus-btn" class="bg-white text-yellow-600 font-bold py-3 px-8 rounded-full text-xl transition-transform transform hover:scale-105">Come√ßar!</button>
            <a href="https://www.eia.pt" target="_blank" class="block text-center text-yellow-100 mt-4 text-sm hover:text-white">www.eia.pt</a>
        </div>
    </div>

    <!-- Modal de Fim de Jogo -->
    <div id="game-over-modal" class="modal">
        <div class="modal-content bg-red-600 p-8 rounded-2xl shadow-2xl text-center max-w-sm mx-4">
            <h2 class="text-4xl font-bold mb-2">Fim de Jogo!</h2>
            <p id="game-over-message" class="text-xl mb-6">Ficaste sem movimentos. Perdeste uma vida!</p>
            <div id="game-over-buttons" class="space-y-3">
                <!-- Bot√µes s√£o inseridos dinamicamente -->
            </div>
             <a href="https://www.eia.pt" target="_blank" class="block text-center text-red-100 mt-4 text-sm hover:text-white">www.eia.pt</a>
        </div>
    </div>

    <!-- Modal de Ajuda do Jogo -->
    <div id="help-modal" class="modal">
        <div class="modal-content bg-gray-800 p-6 rounded-2xl shadow-2xl text-left max-w-lg w-11/12 mx-4 relative">
            <h2 class="text-3xl font-bold mb-4 text-center text-yellow-400">Guia do Jogo</h2>
            <button id="close-help-btn" class="absolute top-4 right-4 text-white bg-red-500 hover:bg-red-600 rounded-full w-8 h-8 flex items-center justify-center font-bold text-xl">X</button>

            <div class="space-y-4 max-h-[70vh] overflow-y-auto pr-2">
                <div>
                    <h3 class="text-xl font-bold text-purple-400">Mec√¢nica B√°sica</h3>
                    <p>Troca duas pe√ßas adjacentes (na vertical ou horizontal) para criar uma linha de 3 ou mais pe√ßas iguais. As pe√ßas combinadas desaparecem e novas pe√ßas caem do topo.</p>
                </div>
                <div>
                    <h3 class="text-xl font-bold text-purple-400">Pontua√ß√£o e B√≥nus</h3>
                    <p>Ganha 10 pontos por cada pe√ßa. Numa s√≥ jogada, mais de 200 pontos d√£o b√≥nus: +5 jogadas ou +5 segundos. Se passares dos 500 pontos, o b√≥nus de tempo sobe para +10 segundos!</p>
                </div>
                <div>
                    <h3 class="text-xl font-bold text-purple-400">Super √çcones</h3>
                    <ul class="list-disc list-inside space-y-2">
                        <li><strong>Pe√ßa Listada (Combina 4):</strong> Limpa uma linha ou coluna inteira.</li>
                        <li><strong>Pe√ßa Embrulhada (Combina 5 em "L" ou "T"):</strong> Explode num raio de 3x3.</li>
                        <li><strong>Bomba de Cor (Combina 5 em linha):</strong> Remove todas as pe√ßas da cor com que for trocada.</li>
                    </ul>
                </div>
                 <div>
                    <h3 class="text-xl font-bold text-purple-400">Mega Combos</h3>
                    <p>Combina dois Super √çcones para efeitos devastadores!</p>
                    <ul class="list-disc list-inside space-y-2">
                        <li><strong>Listada + Listada:</strong> Limpa uma linha E uma coluna.</li>
                        <li><strong>Listada + Embrulhada:</strong> Limpa 3 linhas e 3 colunas.</li>
                        <li><strong>Bomba de Cor + Qualquer Super √çcone:</strong> Transforma todas as pe√ßas da cor do super √≠cone nesse mesmo super √≠cone, ativando-os todos de uma vez.</li>
                        <li><strong>Bomba de Cor + Bomba de Cor:</strong> Limpa o tabuleiro inteiro!</li>
                    </ul>
                </div>
                <div>
                    <h3 class="text-xl font-bold text-purple-400">Legenda de √çcones</h3>
                    <div id="icon-legend-container" class="space-y-2 mt-2">
                        <!-- A legenda ser√° preenchida por JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Gloss√°rio -->
    <div id="glossary-modal" class="modal">
        <div class="modal-content bg-gray-800 p-6 rounded-2xl shadow-2xl text-left max-w-lg w-11/12 mx-4 relative">
            <h2 class="text-3xl font-bold mb-4 text-center text-yellow-400">Gloss√°rio de Energia</h2>
            <button id="close-glossary-btn" class="absolute top-4 right-4 text-white bg-red-500 hover:bg-red-600 rounded-full w-8 h-8 flex items-center justify-center font-bold text-xl">X</button>
            <div id="glossary-content" class="space-y-4 max-h-[70vh] overflow-y-auto pr-2">
                <!-- Conte√∫do do gloss√°rio ser√° inserido aqui -->
            </div>
        </div>
    </div>

    <!-- Modal Hist√≥ria -->
    <div id="history-modal" class="modal">
        <div class="modal-content bg-gray-800 p-6 rounded-2xl shadow-2xl text-left max-w-lg w-11/12 mx-4 relative">
            <h2 class="text-3xl font-bold mb-4 text-center text-teal-400">A Hist√≥ria da EIA</h2>
            <button id="close-history-btn" class="absolute top-4 right-4 text-white bg-red-500 hover:bg-red-600 rounded-full w-8 h-8 flex items-center justify-center font-bold text-xl">X</button>
            <div id="history-content" class="space-y-4 max-h-[70vh] overflow-y-auto pr-2">
                <p class="text-gray-300">Num mundo a lutar por um futuro mais limpo, as for√ßas da Natureza ganham vida! Os Her√≥is da Energia Renov√°vel - Sunny, Breezy e Splashy - unem-se para energizar o planeta de forma sustent√°vel. Mas os Vil√µes dos Combust√≠veis F√≥sseis - Oily, Smokey e Gassy - far√£o de tudo para manter o mundo dependente das suas fontes de energia poluentes. Ajuda os her√≥is nesta batalha √©pica, combinando as energias certas para salvar o dia!</p>

                <div id="heroes-section"></div>
                <div id="villains-section"></div>
            </div>
        </div>
    </div>

    <!-- Modal de Ajuda do Mapa -->
    <div id="world-help-modal" class="modal">
        <div class="modal-content bg-gray-800 p-6 rounded-2xl shadow-2xl text-left max-w-lg w-11/12 mx-4 relative">
            <h2 id="world-help-title" class="text-3xl font-bold mb-4 text-center text-yellow-400">Objetivos do Mundo 1</h2>
            <button id="close-world-help-btn" class="absolute top-4 right-4 text-white bg-red-500 hover:bg-red-600 rounded-full w-8 h-8 flex items-center justify-center font-bold text-xl">X</button>
            <div id="world-help-levels-container" class="space-y-2 max-h-[60vh] overflow-y-auto pr-2">
                <!-- Detalhes dos n√≠veis ser√£o inseridos aqui -->
            </div>
        </div>
    </div>

    <!-- Modal de Desbloqueio -->
    <div id="unlock-modal" class="modal">
        <div class="modal-content bg-gray-800 p-8 rounded-2xl shadow-2xl text-center max-w-sm mx-4">
            <h2 class="text-3xl font-bold mb-4">Desbloquear N√≠veis</h2>
            <p class="text-gray-400 mb-4">Insira o c√≥digo secreto para desbloquear todos os n√≠veis.</p>
            <input id="unlock-code-input" type="text" class="w-full p-2 rounded bg-gray-700 text-white text-center mb-4" placeholder="C√ìDIGO SECRETO">
            <div id="unlock-feedback" class="text-red-500 h-6 mb-2"></div>
            <div class="flex gap-4 justify-center">
                 <button id="submit-unlock-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-full">Confirmar</button>
                 <button id="cancel-unlock-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-full">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Login -->
    <div id="login-modal" class="modal">
        <div class="modal-content bg-gray-800 p-8 rounded-2xl shadow-2xl text-center max-w-sm w-11/12 mx-4">
            <h2 class="text-3xl font-bold mb-4">Login</h2>
            <input id="login-email" type="email" class="w-full p-2 rounded bg-gray-700 text-white text-center mb-4" placeholder="Email">
            <input id="login-password" type="password" class="w-full p-2 rounded bg-gray-700 text-white text-center mb-4" placeholder="Palavra-passe">
            <a href="#" id="forgot-password-link" class="text-blue-400 hover:text-blue-300 text-sm">Esqueceu-se da password?</a>
            <div id="login-feedback" class="text-red-500 h-6 my-2"></div>
            <div class="flex gap-4 justify-center mt-4">
                 <button id="submit-login-btn" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-6 rounded-full">Entrar</button>
                 <button id="cancel-login-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-full">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Reset de Password -->
    <div id="reset-password-modal" class="modal">
        <div class="modal-content bg-gray-800 p-8 rounded-2xl shadow-2xl text-center max-w-sm w-11/12 mx-4">
            <h2 class="text-3xl font-bold mb-4">Recuperar Password</h2>
            <p class="text-gray-400 mb-4">Insira o seu email para receber um link de recupera√ß√£o.</p>
            <input id="reset-email" type="email" class="w-full p-2 rounded bg-gray-700 text-white text-center mb-4" placeholder="Email">
            <div id="reset-feedback" class="h-6 my-2"></div>
            <div class="flex gap-4 justify-center mt-4">
                 <button id="submit-reset-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-full">Enviar</button>
                 <button id="cancel-reset-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-full">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Registo -->
    <div id="register-modal" class="modal">
        <div class="modal-content bg-gray-800 p-8 rounded-2xl shadow-2xl text-center max-w-sm w-11/12 mx-4">
            <h2 class="text-3xl font-bold mb-4">Registar</h2>
            <input id="register-name" type="text" class="w-full p-2 rounded bg-gray-700 text-white text-center mb-4" placeholder="Nome">
            <input id="register-email" type="email" class="w-full p-2 rounded bg-gray-700 text-white text-center mb-4" placeholder="Email">
            <input id="register-password" type="password" class="w-full p-2 rounded bg-gray-700 text-white text-center mb-4" placeholder="Palavra-passe">
            <div id="register-feedback" class="text-red-500 h-6 mb-2"></div>
            <div class="flex gap-4 justify-center">
                 <button id="submit-register-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-full">Registar</button>
                 <button id="cancel-register-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-full">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal Hall of Fame -->
    <div id="hall-of-fame-modal" class="modal">
        <div class="modal-content bg-gray-900 p-4 rounded-2xl shadow-2xl text-left max-w-3xl w-11/12 mx-4 relative flex gap-4">
            <button id="close-hof-btn" class="absolute top-4 right-4 text-white bg-red-500 hover:bg-red-600 rounded-full w-8 h-8 flex items-center justify-center font-bold text-xl z-10">X</button>
            <div id="hof-sidebar" class="w-1/3 bg-gray-800 p-2 rounded-lg flex flex-col gap-2">
                <!-- Sidebar com categorias ser√° gerada aqui -->
            </div>
            <div class="w-2/3 flex flex-col">
                 <h2 id="hof-title" class="text-3xl font-bold mb-4 text-center text-yellow-400">Hall of Fame</h2>
                <div id="hall-of-fame-content" class="space-y-2 max-h-[60vh] overflow-y-auto pr-2 flex-grow">
                    <!-- O ranking ser√° inserido aqui -->
                    <p class="text-center">A carregar o ranking...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Popup de Super √çcone -->
    <div id="super-icon-popup" class="popup bg-purple-500"></div>
    <div id="bonus-popup" class="popup bg-green-500"></div>


    <script type="module">
        // --- IMPORTS E CONFIGURA√á√ÉO DO FIREBASE ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth,
            onAuthStateChanged,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            updateProfile,
            sendPasswordResetEmail
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore,
            doc,
            getDoc,
            setDoc,
            collection,
            query,
            orderBy,
            limit,
            getDocs,
            where
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // #######################################################################
        // IMPORTANTE: COLE A SUA CONFIGURA√á√ÉO DO FIREBASE AQUI
        // #######################################################################
        const firebaseConfig = {
            apiKey: "SUA_API_KEY_AQUI", // IMPORTANTE: Substitua pela sua chave de API do Firebase
            authDomain: "eiacrush.firebaseapp.com",
            projectId: "eiacrush",
            storageBucket: "eiacrush.firebasestorage.app",
            messagingSenderId: "189465509772",
            appId: "1:189465509772:web:64a99ea83a02faac1060a9"
        };
        // #######################################################################

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const appContainer = document.getElementById('app');
        // Vari√°veis para os elementos do DOM
        let gameBoard;
        let musicPlayer;
        let isMuted = false;
        let levelStartTime = null;
        let patchClickCounter = 0;

        const HEROES = [
            {
                name: 'Sunny', color: 'yellow', img: 'https://placehold.co/150x150/f59e0b/ffffff?text=S',
                music: "https://github.com/koelho2000/EIACRUSH/raw/refs/heads/main/Sunny%5BRise&Shine%5D%23EIA.mp3",
                description: 'Sunny √© a personifica√ß√£o da energia solar. Sempre otimista, irradia calor e positividade, iluminando o caminho para um futuro mais limpo.',
                messages: [
                    "Energia limpa a brilhar!", "Um passo de cada vez!", "A efici√™ncia √© a chave!",
                    "Cada ponto conta!", "Futuro brilhante √† vista!", "Est√°s a aquecer!",
                    "Poder solar em a√ß√£o!", "Excelente combina√ß√£o!", "Mant√©m o ritmo!"
                ]
            },
            {
                name: 'Breezy', color: 'blue', img: 'https://placehold.co/150x150/60a5fa/ffffff?text=B',
                music: "https://github.com/koelho2000/EIACRUSH/raw/refs/heads/main/Ride%20the%20Wind%20-%20Breezy's%20Song.mp3",
                description: 'Breezy comanda a for√ßa dos ventos. √â √°gil, r√°pido e livre, representando o poder impar√°vel da energia e√≥lica para mover o mundo.',
                messages: [
                    "Sente a for√ßa do vento!", "Uma brisa de vit√≥ria!", "Leve como o ar!",
                    "A energia e√≥lica n√£o para!", "Impressionante!", "Voando alto!",
                    "Rajada de pontos!", "Que ventania de combina√ß√µes!", "N√£o h√° quem te pare!"
                ]
            },
            {
                name: 'Splashy', color: 'indigo', img: 'https://placehold.co/150x150/4f46e5/ffffff?text=S',
                music: "https://github.com/koelho2000/EIACRUSH/raw/refs/heads/main/Make%20a%20Splash!%20-%20Splashy%E2%80%99s%20Song.mp3",
                description: 'Splashy representa a energia h√≠drica. Calmo mas poderoso, a sua for√ßa reside na const√¢ncia e na capacidade de se adaptar e fluir.',
                messages: [
                    "Um mar de pontos!", "A fluir para a vit√≥ria!", "Puro como a √°gua!",
                    "For√ßa h√≠drica!", "Onda de sucesso!", "Est√°s a mergulhar fundo!",
                    "Cascata de combina√ß√µes!", "Impar√°vel!", "Que corrente de sorte!"
                ]
            },
        ];

        const VILLAINS = [
            { name: 'Oily', color: 'gray', img: 'https://placehold.co/150x150/4b5563/ffffff?text=O',
            music: "https://github.com/koelho2000/EIACRUSH/raw/refs/heads/main/Fuel%20the%20Fire%20-%20Oily's%20Song.mp3",
            description: 'Oily √© o bar√£o do petr√≥leo. Astuto e escorregadio, ele tenta manter o mundo preso ao passado, sujando tudo √† sua volta.', message: "Achavas que ia ser f√°cil? O petr√≥leo ainda manda aqui!" },
            { name: 'Smokey', color: 'orange', img: 'https://placehold.co/150x150/f97316/ffffff?text=S',
            music: "https://github.com/koelho2000/EIACRUSH/raw/refs/heads/main/Smokey%5BBurning-Strong%5D%23EIA.mp3",
            description: 'Smokey √© a personifica√ß√£o da polui√ß√£o do carv√£o. Deixa um rasto de fumo e cinza por onde passa, obscurecendo o futuro.', message: "O meu fumo vai-te deixar a tossir!" },
            { name: 'Gassy', color: 'lime', img: 'https://placehold.co/150x150/84cc16/ffffff?text=G',
            music: "https://github.com/koelho2000/EIACRUSH/raw/refs/heads/main/Zoom,%20Boom,%20Whoosh!%20-%20Gassy%E2%80%99s%20Song.mp3",
            description: 'Gassy representa os gases de efeito estufa. √â vol√°til e trai√ßoeiro, sempre a tentar aquecer o planeta com as suas emiss√µes.', message: "N√£o vais conseguir aguentar este cheiro a derrota!" },
        ];

        const FINAL_BOSS = {
            name: 'EIA Master', color: 'purple', img: 'https://placehold.co/150x150/a855f7/ffffff?text=EIA',
            music: "https://github.com/koelho2000/EIACRUSH/raw/refs/heads/main/Energy%20in%20Action%20-%20song%20theme.mp3"
        };

        const worldCharacters = [
            HEROES[0], HEROES[1], HEROES[2],
            VILLAINS[0], VILLAINS[1], VILLAINS[2]
        ];

        const SUPER_ICON_MESSAGES = {
            'striped-h': "Linha de Energia Horizontal!",
            'striped-v': "Rajada de Energia Vertical!",
            'wrapped': "Explos√£o de Efici√™ncia!",
            'color-bomb': "Poder Crom√°tico!",
            'reshuffle': "Sem mais movimentos... A baralhar!",
            'striped-striped': "Cruzamento de Energia!",
            'striped-wrapped': "Mega Explos√£o!",
            'wrapped-wrapped': "Gigante Explos√£o de Efici√™ncia!",
            'color-bomb-combo': "Cascata de Super Energia!",
            'color-bomb-clear': "Limpeza Total de Energia!"
        };
        const SUPER_COMBO_BONUS = 2000;
        const COLOR_BOMB_BONUS = 1000;

        const ICONS = [
            // Her√≥is
            `<svg viewBox="0 0 100 100"><defs><radialGradient id="gradSun" cx="50%" cy="50%" r="50%" fx="50%" fy="50%"><stop offset="0%" style="stop-color:rgb(255,255,204);stop-opacity:1" /><stop offset="100%" style="stop-color:rgb(253,224,71);stop-opacity:1" /></radialGradient></defs><circle cx="50" cy="50" r="35" fill="url(#gradSun)"/><path d="M50,5 L50,15 M50,85 L50,95 M5,50 L15,50 M85,50 L95,50 M21,21 L28,28 M72,72 L79,79 M21,79 L28,72 M72,28 L79,21" stroke="#FFD700" stroke-width="6" stroke-linecap="round"/></svg>`, // 0: Sol (Sunny)
            `<svg viewBox="0 0 100 100"><defs><linearGradient id="gradWind" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:rgb(224,242,254);stop-opacity:1" /><stop offset="100%" style="stop-color:rgb(147,197,253);stop-opacity:1" /></linearGradient></defs><path d="M20 50 C 40 20, 60 20, 80 50 S 60 80, 40 80" fill="none" stroke="url(#gradWind)" stroke-width="10" stroke-linecap="round"/><path d="M25 65 C 40 45, 60 45, 75 65" fill="none" stroke="#93C5FD" stroke-width="8" stroke-linecap="round"/></svg>`, // 1: Vento (Breezy)
            `<svg viewBox="0 0 100 100"><defs><radialGradient id="gradWater" cx="50%" cy="50%" r="50%" fx="30%" fy="30%"><stop offset="0%" style="stop-color:rgb(224,242,254);stop-opacity:1" /><stop offset="100%" style="stop-color:rgb(59,130,246);stop-opacity:1" /></radialGradient></defs><path d="M50 10 C 20 40, 20 70, 50 90 C 80 70, 80 40, 50 10 Z" fill="url(#gradWater)"/><circle cx="40" cy="40" r="8" fill="rgba(255,255,255,0.7)"/></svg>`, // 2: Gota (Splashy)
            // Vil√µes
            `<svg viewBox="0 0 100 100"><defs><radialGradient id="gradOil" cx="50%" cy="50%" r="50%" fx="30%" fy="30%"><stop offset="0%" style="stop-color:rgb(107,114,128);stop-opacity:1" /><stop offset="100%" style="stop-color:rgb(17,24,39);stop-opacity:1" /></radialGradient></defs><path d="M50 10 C 20 40, 20 70, 50 90 C 80 70, 80 40, 50 10 Z" fill="url(#gradOil)"/><path d="M50 20 C 40 40, 40 60, 50 75 C 60 60, 60 40, 50 20" fill="rgba(255,255,255,0.1)"/></svg>`, // 3: Gota de Petr√≥leo (Oily)
            `<svg viewBox="0 0 100 100"><defs><linearGradient id="gradCoal" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:rgb(75,85,99);stop-opacity:1" /><stop offset="100%" style="stop-color:rgb(31,41,55);stop-opacity:1" /></linearGradient></defs><polygon points="20,45 35,20 65,20 80,45 70,75 50,85 30,75" fill="url(#gradCoal)" stroke="#111827" stroke-width="3"/><polygon points="35,20 50,40 65,20" fill="rgba(255,255,255,0.1)"/><polygon points="20,45 40,55 30,75" fill="rgba(255,255,255,0.05)"/><polygon points="80,45 60,55 70,75" fill="rgba(0,0,0,0.1)"/></svg>`, // 4: Carv√£o (Smokey)
            `<svg viewBox="0 0 100 100"><defs><radialGradient id="gradGas" cx="50%" cy="50%" r="50%" fx="50%" fy="80%"><stop offset="0%" style="stop-color:rgb(251,191,36);stop-opacity:1" /><stop offset="100%" style="stop-color:rgb(239,68,68);stop-opacity:1" /></radialGradient></defs><path d="M50,90 C 20,70 30,30 50,10 C 70,30 80,70 50,90 Z" fill="url(#gradGas)"/><path d="M50,90 C 40,75 45,50 50,30 C 55,50 60,75 50,90 Z" fill="rgba(255,255,255,0.3)"/></svg>`, // 5: Chama de G√°s (Gassy)
            // √çcone da Bomba de Cor
            `<svg viewBox="0 0 100 100"><defs><radialGradient id="gradColorBomb" cx="50%" cy="50%" r="50%" fx="50%" fy="50%"><stop offset="0%" stop-color="#fff" /><stop offset="50%" stop-color="#f9a8d4" /><stop offset="100%" stop-color="#a855f7" /></radialGradient><filter id="glow"><feGaussianBlur stdDeviation="3.5" result="coloredBlur"/><feMerge><feMergeNode in="coloredBlur"/><feMergeNode in="SourceGraphic"/></feMerge></filter></defs><circle cx="50" cy="50" r="30" fill="url(#gradColorBomb)" filter="url(#glow)"/><path d="M50,15 A35,35 0 1,1 15,50" fill="none" stroke="rgba(255,255,255,0.8)" stroke-width="5" stroke-linecap="round" stroke-dasharray="10, 15"/></svg>`
        ];
        const ICON_NAMES = ["Energia Solar", "Energia E√≥lica", "Energia H√≠drica", "Petr√≥leo", "Carv√£o", "G√°s Natural"];

        const COLOR_BOMB_TYPE = ICONS.length - 1;

        const LEVELS = Array.from({ length: 60 }, (_, i) => {
            const level = i + 1;
            const worldIndex = Math.floor(i / 10);
            const character = worldCharacters[worldIndex];
            const isBossLevel = (level % 10 === 0);
            const isTimedLevel = (level % 10 === 5);
            let rows, cols;
            if (level < 10) { rows = 7; cols = 7; } else if (level < 20) { rows = 8; cols = 7; } else if (level < 30) { rows = 8; cols = 8; } else if (level < 40) { rows = 9; cols = 8; } else if (level < 50) { rows = 9; cols = 9; } else { rows = 10; cols = 9; }

            const rawScore = 1500 + Math.floor(Math.pow(i, 1.3) * 100);
            const targetScore = Math.round(rawScore / 250) * 250;
            const moves = Math.max(15, 35 - Math.floor(i / 2.5));

            const config = {
                level,
                rows,
                cols,
                targetScore: targetScore,
                starScores: [Math.round(targetScore * 0.5), targetScore, Math.round(targetScore * 1.5)],
                moves: moves,
                character: character,
                isBoss: isBossLevel,
            };

            if (level === 3) {
                config.jellyLayout = [
                    "J J J J J J J",
                    "J J J J J J J",
                    "J J J J J J J",
                    "J J J J J J J",
                    "J J J J J J J",
                    "J J J J J J J",
                    "J J J J J J J",
                ];
            }
            if (level === 5) {
                config.collect = { 0: 10, 2: 10 }; // Collect 10 suns and 10 water drops
            }
            if (level === 7) {
                config.iceLayout = [
                    "I I I I I I I",
                    "I _ _ _ _ _ I",
                    "I _ _ _ _ _ I",
                    "I _ _ _ _ _ I",
                    "I _ _ _ _ _ I",
                    "I _ _ _ _ _ I",
                    "I I I I I I I",
                ];
            }
            if (level === 9) {
                config.chainLayout = [
                    "C C C C C C C",
                    "C _ _ _ _ _ C",
                    "C _ _ _ _ _ C",
                    "C _ _ _ _ _ C",
                    "C _ _ _ _ _ C",
                    "C _ _ _ _ _ C",
                    "C C C C C C C",
                ];
            }

            if (isTimedLevel) {
                config.time = 180;
                delete config.moves;
            }
            if (isBossLevel) {
                config.time = 120;
                config.autoReshuffle = 10000; // 10 segundos
                delete config.moves;
            }

            return config;
        });

        // N√≠vel Final 61
        LEVELS.push({
            level: 61,
            rows: 10,
            cols: 10,
            targetScore: 50000,
            time: 360,
            character: FINAL_BOSS,
            isBoss: true,
            autoReshuffle: 30000,
            layout: [
                "X L X X X X X X L X",
                "L X X X X X X X X L",
                "X X L X X X X L X X",
                "X X X X X X X X X X",
                "X X X X L L X X X X",
                "X X X X L L X X X X",
                "X X X X X X X X X X",
                "X X L X X X X L X X",
                "L X X X X X X X X L",
                "X L X X X X X X L X"
            ]
        });

        // --- ESTADO DO JOGO ---
        let draggedGem = null;
        let droppedOnGem = null;

        let gameState = {
            currentLevel: 0,
            score: 0,
            totalScore: 0,
            moves: 0,
            timer: null,
            timerInterval: null,
            autoReshuffleInterval: null,
            board: [],
            isLocked: true,
            selectedElement: null,
            hintTimer: null,
            lives: 5,
            highestLevel: 0,
            livesOutTimestamp: null,
            levelStars: {},
            collected: {},
            socialClaims: {
                tiktok: false,
                instagram: false,
                youtube: false
            },
            stats: {},
            totalPlayTimeMinutes: 0,
            energyCoins: 0,
            activeBoosters: [],
            isHammerActive: false
        };

        const BOOSTERS = {
            'gem-hammer': { name: 'Martelo de Gema', cost: 150, description: 'Destr√≥i uma pe√ßa √† escolha.' },
            'extra-striped': { name: '+1 Pe√ßa Listada', cost: 200, description: 'Come√ßa com uma pe√ßa listada aleat√≥ria.' }
        };

        // --- SONS DO JOGO ---
        const sounds = {
            swap: new Tone.FMSynth({ harmonicity: 8, modulationIndex: 2, envelope: { attack: 0.01, decay: 0.2, release: 0.2 }, modulationEnvelope: { attack: 0.01, decay: 0.1, release: 0.1 } }).toDestination(),
            match: new Tone.PluckSynth({ attackNoise: 0.5, dampening: 4000, resonance: 0.9 }).toDestination(),
            super: new Tone.MembraneSynth({ pitchDecay: 0.05, octaves: 10, envelope: { attack: 0.001, decay: 0.4, sustain: 0.01, release: 1.4 } }).toDestination(),
            win: new Tone.PolySynth(Tone.Synth, { oscillator: { type: "fatsawtooth" }, envelope: { attack: 0.05, decay: 0.2, sustain: 0.3, release: 0.5 } }).toDestination(),
            lose: new Tone.PolySynth(Tone.Synth, { oscillator: { type: 'fmsquare', modulationType: 'sawtooth', modulationIndex: 3, harmonicity: 3.4 }, envelope: { attack: 0.05, decay: 0.4, sustain: 0.1, release: 1 } }).toDestination(),
            bonus: new Tone.Synth({ oscillator: { type: 'sine' }, envelope: { attack: 0.005, decay: 0.1, sustain: 0, release: 0.1 } }).toDestination(),
            tick: new Tone.MembraneSynth({ pitchDecay: 0.01, octaves: 6, envelope: { attack: 0.001, decay: 0.2, sustain: 0 } }).toDestination(),
            createSuper: new Tone.Synth({ oscillator: { type: 'triangle' }, envelope: { attack: 0.01, decay: 0.2, sustain: 0.1, release: 0.2 } }).toDestination(),
            combo: new Tone.MetalSynth({ frequency: 200, envelope: { attack: 0.01, decay: 0.4, release: 0.2 }, harmonicity: 5.1, modulationIndex: 32, resonance: 4000, octaves: 1.5 }).toDestination(),
            uiClick: new Tone.Synth({ oscillator: { type: 'sine' }, envelope: { attack: 0.001, decay: 0.1, sustain: 0, release: 0.1 } }).toDestination(),
            iceBreak: new Tone.NoiseSynth({ noise: { type: 'white' }, envelope: { attack: 0.005, decay: 0.15, sustain: 0 } }).toDestination(),
            chainBreak: new Tone.MetalSynth({ frequency: 400, envelope: { attack: 0.001, decay: 0.1, release: 0.1 }, harmonicity: 2.5, modulationIndex: 10, resonance: 800, octaves: 0.5 }).toDestination(),
            jellySplat: new Tone.FMSynth({ harmonicity: 3, modulationIndex: 10, envelope: { attack: 0.01, decay: 0.2, release: 0.2 } }).toDestination(),
            sugarCrushStart: new Tone.PolySynth(Tone.Synth, { oscillator: { type: "fatsawtooth" }, envelope: { attack: 0.05, decay: 0.3, sustain: 0.2, release: 0.4 } }).toDestination()
        };
        sounds.tick.volume.value = -12;
        sounds.iceBreak.volume.value = -10;

        // --- CONTE√öDO EDUCATIVO ---
        const ENERGY_FACTS = [
            "A energia solar captada pela Terra numa hora √© suficiente para abastecer o planeta inteiro por um ano.",
            "Uma √∫nica turbina e√≥lica pode gerar eletricidade suficiente para abastecer cerca de 1.500 casas.",
            "A energia h√≠drica, proveniente da for√ßa da √°gua, √© uma das fontes de energia renov√°vel mais antigas e utilizadas no mundo.",
            "Portugal tem um dos maiores parques de energia solar flutuante da Europa, no Alqueva.",
            "Reduzir a temperatura do seu aquecimento em apenas 1¬∞C pode poupar at√© 10% na sua fatura de energia.",
            "L√¢mpadas LED consomem at√© 80% menos energia e duram 25 vezes mais do que as l√¢mpadas tradicionais.",
            "Deixar aparelhos em stand-by pode representar at√© 10% do consumo de eletricidade de uma casa.",
            "A energia geot√©rmica aproveita o calor do interior da Terra para gerar eletricidade e aquecimento."
        ];

        const ENERGY_GLOSSARY = [
            { name: "Energia Solar", icon: ICONS[0], description: "Gerada a partir da luz e do calor do sol. √â uma das fontes de energia mais limpas e abundantes, captada atrav√©s de pain√©is fotovoltaicos." },
            { name: "Energia E√≥lica", icon: ICONS[1], description: "Produzida pela for√ßa dos ventos. As turbinas e√≥licas convertem o movimento das suas p√°s em eletricidade sem emitir gases poluentes." },
            { name: "Energia H√≠drica", icon: ICONS[2], description: "Utiliza a for√ßa do movimento da √°gua, como em rios e barragens, para gerar eletricidade. √â uma fonte renov√°vel e fi√°vel." },
            { name: "Petr√≥leo", icon: ICONS[3], description: "Um combust√≠vel f√≥ssil que, ao ser queimado, liberta grandes quantidades de di√≥xido de carbono, contribuindo para o aquecimento global." },
            { name: "Carv√£o", icon: ICONS[4], description: "Outro combust√≠vel f√≥ssil e uma das fontes de energia mais poluentes. A sua queima √© uma das principais causas de chuva √°cida e polui√ß√£o do ar." },
            { name: "G√°s Natural", icon: ICONS[5], description: "Um combust√≠vel f√≥ssil menos poluente que o carv√£o e o petr√≥leo, mas que ainda assim liberta gases de efeito estufa na sua combust√£o." }
        ];

        // --- FUN√á√ïES DE √ÅUDIO ---
        function playMusic(src, volume = 0.3) {
            if (!musicPlayer || !src) return;
            // Verifica se a m√∫sica a tocar j√° √© a correta para evitar recarregamentos
            if (musicPlayer.currentSrc && musicPlayer.currentSrc.includes(encodeURI(src))) {
                musicPlayer.volume = isMuted ? 0 : volume;
                if (musicPlayer.paused) {
                    musicPlayer.play().catch(e => console.log("A reprodu√ß√£o foi interrompida."));
                }
                return;
            }
            musicPlayer.src = src;
            musicPlayer.volume = isMuted ? 0 : volume;
            const playPromise = musicPlayer.play();
            if (playPromise !== undefined) {
                playPromise.catch(error => {
                    console.log("A reprodu√ß√£o autom√°tica foi impedida. √â necess√°ria intera√ß√£o do utilizador.");
                });
            }
        }

        function stopMusic() {
            if (!musicPlayer) return;
            musicPlayer.pause();
            musicPlayer.currentTime = 0;
            musicPlayer.src = ""; // Limpa a fonte para garantir que para
        }

        function setMusicVolume(volume) {
            if (!musicPlayer) return;
            musicPlayer.volume = isMuted ? 0 : volume;
        }

        function toggleMute() {
            isMuted = !isMuted;
            Tone.Master.mute = isMuted;
            musicPlayer.muted = isMuted;

            document.getElementById('speaker-icon').classList.toggle('hidden', isMuted);
            document.getElementById('muted-speaker-icon').classList.toggle('hidden', !isMuted);
        }

        // --- FUN√á√ïES PRINCIPAIS DO JOGO ---

        function init() {
            musicPlayer = document.getElementById('music-player');
            document.getElementById('mute-btn').addEventListener('click', toggleMute);

            document.body.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    sounds.uiClick.triggerAttackRelease('C6', '32n');
                }
            });

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    await loadGameData(user.uid);
                    renderMainMenu(user);
                } else {
                    resetLocalGameState();
                    renderMainMenu(null);
                }
            });

            // Listeners dos modais do jogo
            document.getElementById('start-game-btn').addEventListener('click', async () => {
                document.getElementById('level-start-modal').style.display = 'none';
                setMusicVolume(0.1); // Baixa o volume para o n√≠vel
                await startGame();
            });
            document.getElementById('continue-to-score-btn').addEventListener('click', showLevelCompleteModal);
             document.getElementById('back-to-menu-from-complete-btn').addEventListener('click', () => {
                document.getElementById('game-complete-modal').style.display = 'none';
                renderMainMenu(auth.currentUser);
            });
            document.getElementById('continue-to-next-world-btn').addEventListener('click', () => {
                document.getElementById('world-complete-modal').style.display = 'none';
                const nextWorldIndex = Math.floor(gameState.currentLevel / 10) + 1;
                renderWorldMap(nextWorldIndex);
            });
            document.getElementById('start-bonus-btn').addEventListener('click', async () => {
                document.getElementById('bonus-level-modal').style.display = 'none';
                setMusicVolume(0.1);
                await startGame();
            });
            document.getElementById('close-help-btn').addEventListener('click', () => { document.getElementById('help-modal').style.display = 'none'; });
            document.getElementById('close-world-help-btn').addEventListener('click', () => { document.getElementById('world-help-modal').style.display = 'none'; });
            document.getElementById('submit-unlock-btn').addEventListener('click', handleUnlockCode);
            document.getElementById('cancel-unlock-btn').addEventListener('click', () => {
                document.getElementById('unlock-modal').style.display = 'none';
                document.getElementById('unlock-feedback').textContent = '';
                document.getElementById('unlock-code-input').value = '';
            });
            // Listeners dos modais de autentica√ß√£o
            document.getElementById('submit-login-btn').addEventListener('click', handleLogin);
            document.getElementById('cancel-login-btn').addEventListener('click', () => { document.getElementById('login-modal').style.display = 'none'; });
            document.getElementById('submit-register-btn').addEventListener('click', handleRegister);
            document.getElementById('cancel-register-btn').addEventListener('click', () => { document.getElementById('register-modal').style.display = 'none'; });
            document.getElementById('forgot-password-link').addEventListener('click', () => {
                document.getElementById('login-modal').style.display = 'none';
                document.getElementById('reset-password-modal').style.display = 'flex';
            });
            document.getElementById('submit-reset-btn').addEventListener('click', handlePasswordReset);
            document.getElementById('cancel-reset-btn').addEventListener('click', () => {
                document.getElementById('reset-password-modal').style.display = 'none';
            });
            // Listener para fechar o Hall of Fame e o Gloss√°rio
            document.getElementById('close-hof-btn').addEventListener('click', () => { document.getElementById('hall-of-fame-modal').style.display = 'none'; });
            document.getElementById('close-glossary-btn').addEventListener('click', () => { document.getElementById('glossary-modal').style.display = 'none'; });
            document.getElementById('close-history-btn').addEventListener('click', () => { document.getElementById('history-modal').style.display = 'none'; });
        }

        async function prepareLevel() {
            await loadGameData(auth.currentUser?.uid); // Garante que os dados mais recentes est√£o carregados
            const levelConfig = LEVELS[gameState.currentLevel];
            const character = levelConfig.character;
            const modal = document.getElementById('level-start-modal');
            const extraInfoEl = modal.querySelector('#start-modal-extra-info');

            modal.querySelector('#start-char-img').src = character.img;
            modal.querySelector('#start-level').textContent = levelConfig.level;

            let extraText = '';
            if (levelConfig.jellyLayout) extraText += `<span>Objetivo: Limpar toda a geleia!</span>`;
            else if (levelConfig.collect) extraText += `<span>Objetivo: Recolher os √≠cones!</span>`;
            else extraText += `<span>Objetivo: <span id="start-target" class="font-bold">${levelConfig.targetScore}</span> pontos</span>`;

            if (levelConfig.time) extraText += `<br><span class="font-bold text-red-400">Tempo: ${levelConfig.time}s</span>`;
            else extraText += `<br><span>Jogadas: ${levelConfig.moves}</span>`;
            if (levelConfig.autoReshuffle) extraText += `<br><span class="font-bold text-yellow-400">Baralha a cada ${levelConfig.autoReshuffle / 1000}s!</span>`;
            extraInfoEl.innerHTML = extraText;

            // Booster UI
            const boosterContainer = modal.querySelector('#booster-selection');
            const coinsDisplay = modal.querySelector('#booster-energy-coins-display');
            boosterContainer.innerHTML = '';
            coinsDisplay.textContent = gameState.energyCoins;
            gameState.activeBoosters = []; // Reset active boosters on modal open

            Object.keys(BOOSTERS).forEach(key => {
                const booster = BOOSTERS[key];
                const btn = document.createElement('button');
                btn.className = 'p-2 rounded-lg bg-gray-700 hover:bg-gray-600 border-2 border-transparent';
                btn.innerHTML = `<div class="font-bold">${booster.name}</div><div class="text-xs text-yellow-300">Custo: ${booster.cost}</div>`;
                btn.disabled = gameState.energyCoins < booster.cost;
                if (btn.disabled) btn.classList.add('opacity-50');

                btn.addEventListener('click', () => {
                    const index = gameState.activeBoosters.indexOf(key);
                    if (index > -1) {
                        gameState.activeBoosters.splice(index, 1);
                        btn.classList.remove('border-yellow-400');
                    } else {
                        gameState.activeBoosters.push(key);
                        btn.classList.add('border-yellow-400');
                    }
                });
                boosterContainer.appendChild(btn);
            });

            modal.style.display = 'flex';
        }

        async function startGame() {
            patchClickCounter = 0;
            levelStartTime = Date.now();
            const levelConfig = LEVELS[gameState.currentLevel];

            // Activate Boosters
            let cost = 0;
            gameState.activeBoosters.forEach(key => cost += BOOSTERS[key].cost);
            if (gameState.energyCoins >= cost) {
                gameState.energyCoins -= cost;
                if (gameState.activeBoosters.includes('gem-hammer')) {
                    const hammerBtn = document.getElementById('gem-hammer-booster');
                    hammerBtn.classList.remove('hidden');
                    hammerBtn.addEventListener('click', () => {
                        gameState.isHammerActive = !gameState.isHammerActive;
                        hammerBtn.classList.toggle('bg-red-500', gameState.isHammerActive);
                        document.body.style.cursor = gameState.isHammerActive ? 'pointer' : ''; // Simple cursor change
                    });
                }
            } else {
                gameState.activeBoosters = []; // Not enough coins
            }

            gameState.score = 0;
            gameState.collected = {};
            gameState.moves = levelConfig.moves || 0;
            gameState.timer = levelConfig.time || null;
            clearInterval(gameState.timerInterval);
            clearTimeout(gameState.autoReshuffleInterval);

            if (levelConfig.time) gameState.timerInterval = setInterval(countdown, 1000);
            if (levelConfig.autoReshuffle) autoReshuffleLoop();

            gameState.isLocked = true;
            gameState.selectedElement = null;
            updateUI();
            await createBoard();
            resetHintTimer();
        }

        function endLevelPlaytime() {
            if (levelStartTime) {
                const elapsedMilliseconds = Date.now() - levelStartTime;
                const elapsedMinutes = elapsedMilliseconds / 1000 / 60;
                gameState.totalPlayTimeMinutes += elapsedMinutes;
                levelStartTime = null; // Reset timer
            }
        }

        function autoReshuffleLoop() {
            gameState.autoReshuffleInterval = setTimeout(async () => {
                if (!gameState.isLocked) {
                    await reshuffleBoard(false, true);
                }
                autoReshuffleLoop();
            }, LEVELS[gameState.currentLevel].autoReshuffle);
        }

        function countdown() {
            gameState.timer--;
            updateUI();
             if (gameState.timer <= 10 && gameState.timer > 0) {
                sounds.tick.triggerAttackRelease("C5", "32n");
            }
            if (gameState.timer <= 0) {
                clearInterval(gameState.timerInterval);
                levelLose("Ficaste sem tempo!");
            }
        }

        function updateUI() {
            // Menu Screen elements
            const menuLivesDisplay = document.getElementById('menu-lives-display');
            if (menuLivesDisplay) menuLivesDisplay.textContent = gameState.lives;
            const menuTotalScoreDisplay = document.getElementById('menu-total-score-display');
            if (menuTotalScoreDisplay) menuTotalScoreDisplay.textContent = gameState.totalScore.toLocaleString();

            // World Map elements
            const mapTotalScoreDisplay = document.getElementById('map-total-score-display');
            if (mapTotalScoreDisplay) mapTotalScoreDisplay.textContent = gameState.totalScore.toLocaleString();
            const mapEnergyCoinsDisplay = document.getElementById('map-energy-coins-display');
            if (mapEnergyCoinsDisplay) mapEnergyCoinsDisplay.textContent = gameState.energyCoins;

            // Game Screen elements
            const gameTotalScoreDisplay = document.getElementById('game-total-score-display');
            if (gameTotalScoreDisplay) gameTotalScoreDisplay.textContent = gameState.totalScore.toLocaleString();

            const scoreDisplay = document.getElementById('game-score-display');
            if (scoreDisplay) scoreDisplay.textContent = gameState.score;

            const levelDisplay = document.getElementById('game-level-display');
            if (levelDisplay) levelDisplay.textContent = LEVELS[gameState.currentLevel].level;

            const characterNameDisplay = document.getElementById('game-character-display');
            if (characterNameDisplay) characterNameDisplay.textContent = LEVELS[gameState.currentLevel].character.name;

            const targetScoreDisplay = document.getElementById('game-target-display');
            const objectiveDisplay = document.getElementById('objective-display');
            const levelConfig = LEVELS[gameState.currentLevel];
            let isNearComplete = false;

            if (levelConfig.jellyLayout) {
                const jellyRemaining = gameState.board.flat().filter(gem => gem && gem.jelly).length;
                objectiveDisplay.innerHTML = `
                    <div class="text-sm opacity-80">Geleia</div>
                    <div id="game-jelly-display" class="text-2xl font-bold">${jellyRemaining}</div>
                `;
                if (jellyRemaining > 0 && jellyRemaining <= 3) {
                    isNearComplete = true;
                }
            } else if (levelConfig.collect) {
                let totalRemaining = 0;
                let html = '<div class="text-sm opacity-80">Recolher</div><div class="flex justify-center items-center gap-2">';
                for (const type in levelConfig.collect) {
                    const remaining = Math.max(0, levelConfig.collect[type] - (gameState.collected[type] || 0));
                    totalRemaining += remaining;
                    html += `<div class="flex items-center">${ICONS[type]}<span class="text-lg font-bold ml-1">${remaining}</span></div>`;
                }
                html += '</div>';
                objectiveDisplay.innerHTML = html;
                if (totalRemaining > 0 && totalRemaining <= 3) {
                    isNearComplete = true;
                }
            } else {
                objectiveDisplay.innerHTML = `
                    <div class="text-sm opacity-80">Objetivo</div>
                    <div id="game-target-display" class="text-2xl font-bold">${levelConfig.targetScore}</div>
                `;
                if (gameState.score >= levelConfig.targetScore * 0.9 && gameState.score < levelConfig.targetScore) {
                    isNearComplete = true;
                }
            }

            objectiveDisplay.classList.toggle('objective-near-complete', isNearComplete);

            const gameLivesDisplay = document.getElementById('game-lives-display');
            if (gameLivesDisplay) gameLivesDisplay.textContent = gameState.lives;

            const movesOrTimeWrapper = document.getElementById('moves-or-time-display');
            if (movesOrTimeWrapper) {
                const levelConfig = LEVELS[gameState.currentLevel];
                if (levelConfig.time !== undefined) {
                    movesOrTimeWrapper.innerHTML = `
                        <div class="text-sm opacity-80">Tempo</div>
                        <div id="game-timer-display" class="text-2xl font-bold">${gameState.timer}</div>
                    `;
                    const timerDisplay = document.getElementById('game-timer-display');
                    if (timerDisplay) {
                        timerDisplay.classList.toggle('low-time', gameState.timer <= 10);
                    }
                } else {
                    movesOrTimeWrapper.innerHTML = `
                        <div class="text-sm opacity-80">Jogadas</div>
                        <div id="game-moves-display" class="text-2xl font-bold">${gameState.moves}</div>
                    `;
                    const movesDisplay = document.getElementById('game-moves-display');
                    if(movesDisplay) {
                       movesDisplay.classList.toggle('low-moves', gameState.moves <= 5);
                    }
                }
            }

            const gameContainer = document.getElementById('game-container');
            if (gameContainer) {
                 const character = LEVELS[gameState.currentLevel].character;
                 const colorMap = { yellow: '#f59e0b', blue: '#3b82f6', indigo: '#4f46e5', gray: '#4b5563', orange: '#f97316', lime: '#84cc16', purple: '#a855f7' };
                 gameContainer.style.background = `radial-gradient(circle, ${colorMap[character.color]} 0%, #111827 100%)`;
            }
        }

        async function createBoard() {
            const levelConfig = LEVELS[gameState.currentLevel];
            const { rows, cols, layout, jellyLayout, iceLayout, chainLayout } = levelConfig;
            gameState.board = [];
            gameBoard.innerHTML = '';
            gameBoard.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
            gameBoard.style.gridTemplateRows = `repeat(${rows}, 1fr)`;

            let attempts = 0;
            do {
                gameState.board = []; // Reset board on each attempt
                for (let r = 0; r < rows; r++) {
                    const row = [];
                    for (let c = 0; c < cols; c++) {
                        if (layout && layout[r].split(' ')[c] === '_') {
                            row.push(null);
                            continue;
                        }
                        let type;
                        do {
                            type = Math.floor(Math.random() * (ICONS.length - 1));
                        } while (
                            (c >= 2 && type === row[c - 1]?.type && type === row[c - 2]?.type) ||
                            (r >= 2 && type === gameState.board[r - 1]?.[c]?.type && type === gameState.board[r - 2]?.[c]?.type)
                        );
                        const gemData = { type, superType: null, isLocked: layout && layout[r].split(' ')[c] === 'L', jelly: jellyLayout && jellyLayout[r].split(' ')[c] === 'J', ice: iceLayout && iceLayout[r].split(' ')[c] === 'I', chains: chainLayout && chainLayout[r].split(' ')[c] === 'C' };
                        row.push(gemData);
                    }
                    gameState.board.push(row);
                }
                attempts++;
            } while ((findMatches().size > 0 || !checkForPossibleMoves()) && attempts < 20);

            if (gameState.activeBoosters.includes('extra-striped')) {
                let placed = false;
                while (!placed) {
                    const r = Math.floor(Math.random() * rows);
                    const c = Math.floor(Math.random() * cols);
                    if (gameState.board[r][c]) {
                        gameState.board[r][c].superType = Math.random() < 0.5 ? 'striped-h' : 'striped-v';
                        placed = true;
                    }
                }
            }

            renderBoard();
            gameState.isLocked = false;
        }

        function renderBoard() {
            if (!gameBoard) return;
            gameBoard.innerHTML = '';
            const containerWidth = gameBoard.parentElement.offsetWidth;
            const cols = LEVELS[gameState.currentLevel].cols;
            const gap = 4;
            const padding = 8;
            const gemSize = (containerWidth - (padding * 2) - (gap * (cols - 1))) / cols;
            gameState.board.forEach((row, r) => {
                row.forEach((gemData, c) => {
                    const cell = document.createElement('div');
                    if (gemData) {
                        cell.classList.add('gem');
                        cell.dataset.r = r;
                        cell.dataset.c = c;
                        cell.style.width = `${gemSize}px`;
                        cell.style.height = `${gemSize}px`;
                        cell.style.top = `${r * (gemSize + gap)}px`;
                        cell.style.left = `${c * (gemSize + gap)}px`;
                        cell.style.position = 'absolute';
                        cell.innerHTML = ICONS[gemData.type];
                        if (gemData.superType) {
                            cell.classList.add(`super-${gemData.superType}`);
                        }
                        if (gemData.isNew) {
                            cell.classList.add('gem-entering');
                            delete gemData.isNew; // Remove the flag after applying the animation
                        }
                        if (gemData.jelly) {
                            const jellyDiv = document.createElement('div');
                            jellyDiv.className = 'jelly';
                            cell.appendChild(jellyDiv);
                        }
                        if (gemData.ice) {
                            const iceDiv = document.createElement('div');
                            iceDiv.className = 'ice';
                            cell.appendChild(iceDiv);
                        }
                        if (gemData.chains) {
                            const chainDiv = document.createElement('div');
                            chainDiv.className = 'chains';
                            cell.appendChild(chainDiv);
                        }
                        if (gemData.isLocked) {
                            cell.classList.add('is-locked');
                        } else {
                            cell.setAttribute('draggable', true);
                            cell.addEventListener('dragstart', handleDragStart);
                            cell.addEventListener('dragover', handleDragOver);
                            cell.addEventListener('drop', handleDrop);
                        }
                        cell.addEventListener('click', gemClick);
                    } else {
                        cell.classList.add('hole');
                    }
                    gameBoard.appendChild(cell);
                });
            });
        }

        // --- L√ìGICA DE MOVIMENTO (DRAG & DROP) ---

        function handleDragStart(e) {
            draggedGem = this;
        }

        function handleDragOver(e) {
            e.preventDefault();
        }

        async function handleDrop(e) {
            e.preventDefault();
            droppedOnGem = this;

            const r1 = parseInt(draggedGem.dataset.r);
            const c1 = parseInt(draggedGem.dataset.c);
            const r2 = parseInt(droppedOnGem.dataset.r);
            const c2 = parseInt(droppedOnGem.dataset.c);

            const isAdjacent = Math.abs(r1 - r2) + Math.abs(c1 - c2) === 1;
            if (isAdjacent) {
                await swap(r1, c1, r2, c2);
            }
        }

        // --- L√ìGICA DE MOVIMENTO (CLIQUE) ---

        async function gemClick(e) {
            if (gameState.isLocked) return;
            resetHintTimer();
            const clickedGem = e.target.closest('.gem');
            if (!clickedGem) return;

            const r = parseInt(clickedGem.dataset.r);
            const c = parseInt(clickedGem.dataset.c);

            // --- Patch Logic Start ---
            const levelConfig = LEVELS[gameState.currentLevel];
            const targetR = levelConfig.rows - 1;
            const targetC = levelConfig.cols - 1;

            if (gameState.isHammerActive) {
                const gemElement = e.target.closest('.gem');
                if (gemElement) {
                    const r_hammer = parseInt(gemElement.dataset.r);
                    const c_hammer = parseInt(gemElement.dataset.c);
                    explodeGems(new Set([`${r_hammer}-${c_hammer}`]), 1);
                    gameState.isHammerActive = false;
                    document.getElementById('gem-hammer-booster').classList.add('hidden');
                    document.body.style.cursor = '';
                }
                return;
            }

            if (r === targetR && c === targetC) {
                patchClickCounter++;
                if (patchClickCounter >= 5) {
                    console.log("Patch ativado: N√≠vel conclu√≠do!");
                    patchClickCounter = 0; // Reset for next time
                    levelWin();
                    return; // Stop further execution
                }
            } else {
                patchClickCounter = 0; // Reset if another gem is clicked
            }
            // --- Patch Logic End ---

            if (gameState.board[r][c]?.isLocked) return;

            if (gameState.selectedElement) {
                const r1 = parseInt(gameState.selectedElement.dataset.r);
                const c1 = parseInt(gameState.selectedElement.dataset.c);
                const r2 = r;
                const c2 = c;

                gameState.selectedElement.classList.remove('is-selected');

                if (gameState.selectedElement === clickedGem) {
                    gameState.selectedElement = null;
                    return;
                }

                const isAdjacent = Math.abs(r1 - r2) + Math.abs(c1 - c2) === 1;
                if (isAdjacent) {
                    await swap(r1, c1, r2, c2);
                    gameState.selectedElement = null;
                } else {
                    gameState.selectedElement = clickedGem;
                    clickedGem.classList.add('is-selected');
                    sounds.swap.triggerAttackRelease('C5', '16n');
                }
            } else {
                gameState.selectedElement = clickedGem;
                clickedGem.classList.add('is-selected');
                sounds.swap.triggerAttackRelease('C5', '16n');
            }
        }

        async function swap(r1, c1, r2, c2, isUndo = false) {
            if (gameState.isLocked && !isUndo) return;
            const gem1 = gameState.board[r1]?.[c1];
            const gem2 = gameState.board[r2]?.[c2];

            // Prevent swapping locked or iced gems. Chained gems can be swapped.
            if (!gem1 || !gem2 || gem1.isLocked || gem2.isLocked || gem1.ice || gem2.ice) {
                return;
            }

            // A chained gem cannot be swapped with an empty space.
            if ((gem1.chains && !gem2) || (gem2.chains && !gem1)) {
                return;
            }

            gameState.isLocked = true;

            try {
                // Prioridade 1: Dois Super √çcones
                if (!isUndo && gem1?.superType && gem2?.superType) {
                    if (LEVELS[gameState.currentLevel].moves !== undefined) gameState.moves--;
                    updateUI();
                    await handleSuperSuperSwap(r1, c1, r2, c2);
                    return; // Termina a fun√ß√£o aqui
                }

                // Prioridade 2: Um dos √≠cones √© Bomba de Cor (e o outro n√£o √© super)
                if (!isUndo && (gem1?.superType === 'color-bomb' || gem2?.superType === 'color-bomb')) {
                    if (LEVELS[gameState.currentLevel].moves !== undefined) gameState.moves--;
                    updateUI();
                    await handleColorBombSwap(r1, c1, r2, c2);
                    return; // Termina a fun√ß√£o aqui
                }

                // L√≥gica normal de troca
                if (!isUndo && LEVELS[gameState.currentLevel].moves !== undefined) {
                    gameState.moves--;
                    updateUI();
                }

                const gem1Element = document.querySelector(`.gem[data-r='${r1}'][data-c='${c1}']`);
                const gem2Element = document.querySelector(`.gem[data-r='${r2}'][data-c='${c2}']`);

                if (gem1Element && gem2Element) {
                    gem1Element.classList.add('gem-swap');
                    gem2Element.classList.add('gem-swap');

                    const tempTop = gem1Element.style.top;
                    const tempLeft = gem1Element.style.left;
                    gem1Element.style.top = gem2Element.style.top;
                    gem1Element.style.left = gem2Element.style.left;
                    gem2Element.style.top = tempTop;
                    gem2Element.style.left = tempLeft;

                    gem1Element.dataset.r = r2;
                    gem1Element.dataset.c = c2;
                    gem2Element.dataset.r = r1;
                    gem2Element.dataset.c = c1;
                }

                gameState.board[r1][c1] = gem2;
                gameState.board[r2][c2] = gem1;

                if (!isUndo) sounds.swap.triggerAttackRelease('G5', '8n');
                await delay(300);
                if(gem1Element) gem1Element.classList.remove('gem-swap');
                if(gem2Element) gem2Element.classList.remove('gem-swap');

                // Re-render the board to fix visual data attributes after a swap
                renderBoard();

                const matches = findMatches();
                if (matches.size > 0) {
                    await handleMatches(matches, {r: r2, c: c2});
                } else if (!isUndo) {
                    if (LEVELS[gameState.currentLevel].moves !== undefined) gameState.moves++;
                    updateUI();

                    const gem1Element = document.querySelector(`.gem[data-r='${r1}'][data-c='${c1}']`);
                    const gem2Element = document.querySelector(`.gem[data-r='${r2}'][data-c='${c2}']`);
                    if(gem1Element) gem1Element.style.animation = 'shake 0.5s';
                    if(gem2Element) gem2Element.style.animation = 'shake 0.5s';

                    await delay(500);

                    if(gem1Element) gem1Element.style.animation = '';
                    if(gem2Element) gem2Element.style.animation = '';

                    await swap(r1, c1, r2, c2, true);
                }
            } finally {
                 if (!isUndo) {
                    gameState.isLocked = false;
                    checkGameEnd();
                    resetHintTimer();
                } else {
                    gameState.isLocked = false;
                }
            }
        }

        // --- L√ìGICA DE COMBINA√á√ïES E CASCATAS ---

        function findMatches() {
            const levelConfig = LEVELS[gameState.currentLevel];
            const { rows, cols } = levelConfig;
            const matches = new Set();
            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < cols - 2; c++) {
                    const gem1 = gameState.board[r][c];
                    if (!gem1 || gem1.type === COLOR_BOMB_TYPE || gem1.isLocked || gem1.chains) continue;
                    const gem2 = gameState.board[r][c + 1];
                    const gem3 = gameState.board[r][c + 2];
                    if (gem2 && gem3 && !gem2.isLocked && !gem2.chains && !gem3.isLocked && !gem3.chains && gem1.type === gem2.type && gem2.type === gem3.type) {
                        let i = c;
                        while(i < cols && gameState.board[r][i]?.type === gem1.type && !gameState.board[r][i]?.isLocked && !gameState.board[r][i]?.chains) {
                            matches.add(`${r}-${i}`);
                            i++;
                        }
                    }
                }
            }
            for (let c = 0; c < cols; c++) {
                for (let r = 0; r < rows - 2; r++) {
                    const gem1 = gameState.board[r][c];
                    if (!gem1 || gem1.type === COLOR_BOMB_TYPE || gem1.isLocked || gem1.chains) continue;
                    const gem2 = gameState.board[r + 1][c];
                    const gem3 = gameState.board[r + 2][c];
                     if (gem2 && gem3 && !gem2.isLocked && !gem2.chains && !gem3.isLocked && !gem3.chains && gem1.type === gem2.type && gem2.type === gem3.type) {
                        let i = r;
                        while(i < rows && gameState.board[i][c]?.type === gem1.type && !gameState.board[i][c]?.isLocked && !gameState.board[i][c]?.chains) {
                            matches.add(`${i}-${c}`);
                            i++;
                        }
                    }
                }
            }
            return matches;
        }

        async function handleMatches(initialMatches, swapPosition, bonusPoints = 0) {
            gameState.isLocked = true;
            let chain = 1;
            let explosionQueue = new Set(initialMatches);
            let totalBonus = bonusPoints;
            let pointsThisTurn = 0;

            while (explosionQueue.size > 0) {
                const currentExplosions = new Set(explosionQueue);
                explosionQueue.clear();

                await activateSuperIcons(currentExplosions);

                const { newSuperIcons, allMatchedGems } = createSuperIcons(findMatches(), swapPosition);
                allMatchedGems.forEach(gem => currentExplosions.add(gem));

                const pointsFromExplosion = await explodeGems(currentExplosions, chain, totalBonus);
                pointsThisTurn += pointsFromExplosion;
                totalBonus = 0;

                newSuperIcons.forEach(superIcon => {
                    gameState.board[superIcon.r][superIcon.c] = { type: superIcon.type, superType: superIcon.superType };
                });

                await processBoardAfterExplosion();

                const newMatches = findMatches();
                newMatches.forEach(match => explosionQueue.add(match));
                if (newMatches.size > 0) chain++;
            }

            if (pointsThisTurn > 200) {
                const levelConfig = LEVELS[gameState.currentLevel];
                if (levelConfig.time !== undefined) {
                    if (pointsThisTurn >= 500) {
                        gameState.timer += 10;
                        showBonusPopup("+10 Segundos!");
                    } else {
                        gameState.timer += 5;
                        showBonusPopup("+5 Segundos!");
                    }
                    updateUI();
                } else if (levelConfig.moves !== undefined) {
                    gameState.moves += 5;
                    showBonusPopup("+5 Jogadas!");
                    updateUI();
                }
            }

            if (!checkForPossibleMoves()) {
                await reshuffleBoard();
            }

            gameState.isLocked = false;
            resetHintTimer();
        }

        async function processBoardAfterExplosion() {
            await delay(200);
            await dropGems();
            await fillGems();
            renderBoard();
            await delay(300);
        }

        function analyzeMatchShape(coordsSet) {
            const coords = Array.from(coordsSet).map(c => c.split('-').map(Number));
            const rows = [...new Set(coords.map(c => c[0]))];
            const cols = [...new Set(coords.map(c => c[1]))];
            if (coords.length >= 5) {
                if (rows.length === 1 || cols.length === 1) return { shape: 'line-5', orientation: rows.length === 1 ? 'horizontal' : 'vertical' };
                return { shape: 'L/T' };
            }
            if (coords.length === 4) {
                if (rows.length === 1 || cols.length === 1) return { shape: 'line-4', orientation: rows.length === 1 ? 'horizontal' : 'vertical' };
            }
            return { shape: 'line-3' };
        }

        function createSuperIcons(allMatches, swapPosition) {
            const newSuperIcons = [];
            const allMatchedGems = new Set();
            const groupedMatches = groupMatches(allMatches);

            groupedMatches.forEach(matchGroup => {
                const { shape, orientation } = analyzeMatchShape(matchGroup);
                let superType = null;
                if (shape === 'line-5') superType = 'color-bomb';
                else if (shape === 'L/T') superType = 'wrapped';
                else if (shape === 'line-4') superType = orientation === 'horizontal' ? 'striped-v' : 'striped-h';

                if (superType) {
                    sounds.createSuper.triggerAttackRelease('C5', '8n');
                    let [r, c] = matchGroup.values().next().value.split('-').map(Number);
                    if (swapPosition && matchGroup.has(`${swapPosition.r}-${swapPosition.c}`)) {
                        r = swapPosition.r; c = swapPosition.c;
                    }
                    const gemData = gameState.board[r]?.[c];
                    if (gemData) {
                       const type = superType === 'color-bomb' ? COLOR_BOMB_TYPE : gemData.type;
                       newSuperIcons.push({ r, c, type, superType });
                       incrementStat(superType, gemData.type);
                       matchGroup.forEach(coord => allMatchedGems.add(coord));
                       allMatchedGems.delete(`${r}-${c}`);

                       // Animate the creation
                        const gemElement = document.querySelector(`.gem[data-r='${r}'][data-c='${c}']`);
                        if(gemElement) {
                            gemElement.classList.add('super-gem-creation');
                            setTimeout(() => gemElement.classList.remove('super-gem-creation'), 600);
                        }
                    }
                } else {
                    matchGroup.forEach(coord => allMatchedGems.add(coord));
                }
            });

            return { newSuperIcons, allMatchedGems };
        }

        function groupMatches(matchSet) {
            const groups = [];
            const visited = new Set();
            for (const coord of matchSet) {
                if (visited.has(coord)) continue;
                const group = new Set();
                const queue = [coord];
                visited.add(coord);
                const [startR, startC] = coord.split('-').map(Number);
                const gemType = gameState.board[startR]?.[startC]?.type;
                if (gemType === undefined) continue;

                while (queue.length > 0) {
                    const current = queue.shift();
                    group.add(current);
                    const [r, c] = current.split('-').map(Number);

                    [[r-1,c],[r+1,c],[r,c-1],[r,c+1]].forEach(([nr, nc]) => {
                        const nextCoord = `${nr}-${nc}`;
                        if (matchSet.has(nextCoord) && !visited.has(nextCoord) && gameState.board[nr]?.[nc]?.type === gemType) {
                            visited.add(nextCoord);
                            queue.push(nextCoord);
                        }
                    });
                }
                groups.push(group);
            }
            return groups;
        }

        async function activateSuperIcons(explosionSet) {
            const levelConfig = LEVELS[gameState.currentLevel];
            const iconsToActivate = [...explosionSet];
            let activatedAny = false;
            for (const coord of iconsToActivate) {
                const [r, c] = coord.split('-').map(Number);
                const gemData = gameState.board[r]?.[c];
                if (gemData?.superType) {
                    activatedAny = true;
                    showSuperIconPopup(gemData.superType);
                    switch (gemData.superType) {
                        case 'striped-h':
                            animateLineClear(r, c, 'h');
                            for (let i = 0; i < levelConfig.cols; i++) explosionSet.add(`${r}-${i}`);
                            break;
                        case 'striped-v':
                            animateLineClear(r, c, 'v');
                            for (let i = 0; i < levelConfig.rows; i++) explosionSet.add(`${i}-${c}`);
                            break;
                        case 'wrapped':
                            animateShockwave(r, c);
                            for (let dr = -1; dr <= 1; dr++) for (let dc = -1; dc <= 1; dc++) {
                                if (r + dr >= 0 && r + dr < levelConfig.rows && c + dc >= 0 && c + dc < levelConfig.cols) explosionSet.add(`${r+dr}-${c+dc}`);
                            }
                            break;
                    }
                    gemData.superType = null;
                }
            }
            if (activatedAny) {
                sounds.super.triggerAttackRelease('C3', '8n');
            }
        }

        async function handleSuperSuperSwap(r1, c1, r2, c2) {
            const levelConfig = LEVELS[gameState.currentLevel];
            const explosionSet = new Set();
            const gem1 = gameState.board[r1][c1];
            const gem2 = gameState.board[r2][c2];

            if (!gem1 || !gem2) {
                console.error("Tentativa de combinar super √≠cones inexistentes.");
                return;
            }

            const types = [gem1.superType, gem2.superType].sort();
            sounds.combo.triggerAttackRelease();

            // Limpa os √≠cones originais do tabuleiro imediatamente
            gameState.board[r1][c1] = null;
            gameState.board[r2][c2] = null;
            explosionSet.add(`${r1}-${c1}`);
            explosionSet.add(`${r2}-${c2}`);

            // Caso 1: Bomba de Cor + Bomba de Cor
            if (types[0] === 'color-bomb' && types[1] === 'color-bomb') {
                showSuperIconPopup('color-bomb-clear');
                await animateBoardClear(r2, c2); // Anima√ß√£o de limpeza
                for (let r = 0; r < levelConfig.rows; r++) {
                    for (let c = 0; c < levelConfig.cols; c++) {
                        if (gameState.board[r][c] !== null) {
                           explosionSet.add(`${r}-${c}`);
                        }
                    }
                }
            }
            // Caso 2: Bomba de Cor + Outro Super √çcone
            else if (types[0] === 'color-bomb') {
                showSuperIconPopup('color-bomb-combo');
                const otherGem = gem1.superType === 'color-bomb' ? gem2 : gem1;
                const otherSuperType = otherGem.superType;
                const typeToTransform = otherGem.type;

                gameState.board.forEach((row, r) => {
                    row.forEach((gem, c) => {
                        if (gem?.type === typeToTransform) {
                            gem.superType = otherSuperType;
                            explosionSet.add(`${r}-${c}`);
                        }
                    });
                });
            }
            // Caso 3: Embrulhada + Embrulhada
            else if (types[0] === 'wrapped' && types[1] === 'wrapped') {
                showSuperIconPopup('wrapped-wrapped');
                document.getElementById('game-container').classList.add('screen-shake');
                setTimeout(() => document.getElementById('game-container').classList.remove('screen-shake'), 400);
                // Explos√£o 5x5 centrada no destino da jogada (r2, c2)
                for (let dr = -2; dr <= 2; dr++) {
                    for (let dc = -2; dc <= 2; dc++) {
                        const nr = r2 + dr;
                        const nc = c2 + dc;
                        if (nr >= 0 && nr < levelConfig.rows && nc >= 0 && nc < levelConfig.cols) {
                            explosionSet.add(`${nr}-${nc}`);
                        }
                    }
                }
            }
            // Caso 4: Listada + Embrulhada
            else if (types[0].startsWith('striped') && types[1] === 'wrapped') {
                showSuperIconPopup('striped-wrapped');
                document.getElementById('game-container').classList.add('screen-shake');
                setTimeout(() => document.getElementById('game-container').classList.remove('screen-shake'), 400);
                // 3 linhas e 3 colunas centradas no destino (r2,c2)
                for (let i = -1; i <= 1; i++) {
                    const rowToClear = r2 + i;
                    if (rowToClear >= 0 && rowToClear < levelConfig.rows) {
                        for (let c = 0; c < levelConfig.cols; c++) explosionSet.add(`${rowToClear}-${c}`);
                    }
                    const colToClear = c2 + i;
                    if (colToClear >= 0 && colToClear < levelConfig.cols) {
                        for (let r = 0; r < levelConfig.rows; r++) explosionSet.add(`${r}-${colToClear}`);
                    }
                }
            }
            // Caso 5: Listada + Listada
            else if (types[0].startsWith('striped') && types[1].startsWith('striped')) {
                showSuperIconPopup('striped-striped');
                // 1 linha e 1 coluna a partir do ponto de destino
                for (let i = 0; i < levelConfig.cols; i++) explosionSet.add(`${r2}-${i}`);
                for (let i = 0; i < levelConfig.rows; i++) explosionSet.add(`${i}-${c2}`);
            }

            await handleMatches(explosionSet, null, SUPER_COMBO_BONUS);
        }

        async function handleColorBombSwap(r1, c1, r2, c2) {
            // Esta fun√ß√£o trata APENAS de trocas de Bomba de Cor + pe√ßa REGULAR.
            const bombCoord = gameState.board[r1][c1]?.superType === 'color-bomb' ? {r:r1, c:c1} : {r:r2, c:c2};
            const targetGem = gameState.board[r1][c1]?.superType !== 'color-bomb' ? gameState.board[r1][c1] : gameState.board[r2][c2];

            const explosionSet = new Set();

            showSuperIconPopup('color-bomb');
            if (targetGem) { // targetGem ser√° uma pe√ßa regular
                const typeToClear = targetGem.type;
                gameState.board.forEach((row, r) => row.forEach((gem, c) => {
                    if (gem?.type === typeToClear) explosionSet.add(`${r}-${c}`);
                }));
            }

            // Adiciona a bomba e a pe√ßa alvo √† explos√£o para serem removidas
            explosionSet.add(`${r1}-${c1}`);
            explosionSet.add(`${r2}-${c2}`);
            gameState.board[r1][c1] = null;
            gameState.board[r2][c2] = null;

            await handleMatches(explosionSet, null, COLOR_BOMB_BONUS);
        }

        async function explodeGems(matches, chain, bonus = 0) {
            if (matches.size === 0) return 0;

            const points = (matches.size * 10 * chain) + bonus;

            const coords = Array.from(matches).map(c => c.split('-').map(Number));
            const avgR = coords.reduce((sum, c) => sum + c[0], 0) / coords.length;
            const avgC = coords.reduce((sum, c) => sum + c[1], 0) / coords.length;

            if (points > 0) {
                showPointsAnimation(points, avgR, avgC, bonus > 0);
                await animateScore(gameState.score + points);
            }

            const pitch = Tone.Frequency("C4").transpose(chain - 1);
            sounds.match.triggerAttackRelease(pitch, '8n');

            const iceToBreak = new Set();

            for (const coord of matches) {
                const [r, c] = coord.split('-').map(Number);
                const gemData = gameState.board[r]?.[c];
                if (!gemData) continue;

                 [[r,c],[r-1,c],[r+1,c],[r,c-1],[r,c+1]].forEach(([nr, nc]) => {
                    if (gameState.board[nr]?.[nc]?.ice) {
                        iceToBreak.add(`${nr}-${nc}`);
                    }
                });
            }

            for (const coord of iceToBreak) {
                const [r, c] = coord.split('-').map(Number);
                const gemData = gameState.board[r]?.[c];
                if (gemData && gemData.ice) {
                    gemData.ice = false;
                    sounds.iceBreak.triggerAttackRelease("8n");
                    const iceDiv = document.querySelector(`.gem[data-r='${r}'][data-c='${c}'] .ice`);
                    if (iceDiv) {
                        iceDiv.classList.add('ice-shatter');
                        setTimeout(() => iceDiv.remove(), 400);
                    }
                }
            }

            for (const coord of matches) {
                const [r, c] = coord.split('-').map(Number);
                const gemElement = document.querySelector(`.gem[data-r='${r}'][data-c='${c}']`);
                const gemData = gameState.board[r]?.[c];

                if (gemElement && gemData) {
                    if (LEVELS[gameState.currentLevel].collect && LEVELS[gameState.currentLevel].collect[gemData.type] !== undefined) {
                        gameState.collected[gemData.type] = (gameState.collected[gemData.type] || 0) + 1;
                        animateCollect(gemElement);
                    }

                    if (gemData.chains) {
                        gemData.chains = false;
                        sounds.chainBreak.triggerAttackRelease("C3", "8n");
                        const chainDiv = gemElement.querySelector('.chains');
                        if (chainDiv) {
                            chainDiv.classList.add('chain-break');
                             setTimeout(() => chainDiv.remove(), 500);
                        }
                    }

                    if (gemData.jelly) {
                        gemData.jelly = false;
                        sounds.jellySplat.triggerAttackRelease("G2", "8n");
                        const jellyDiv = gemElement.querySelector('.jelly');
                        if (jellyDiv) {
                           jellyDiv.classList.add('jelly-splat');
                           setTimeout(() => jellyDiv.remove(), 300);
                        }
                    }

                    const svg = ICONS[gemData.type];
                    const match = svg.match(/fill="url\(#(\w+)\)"/);
                    let color = '#ccc';
                    if (match) {
                        const gradientId = match[1];
                        const gradient = document.getElementById(gradientId);
                        if (gradient) {
                            const stop = gradient.querySelector('stop[offset="100%"]');
                            if (stop) color = stop.style.stopColor;
                        }
                    }
                    createParticleExplosion(r, c, color);

                    gemElement.classList.remove('is-locked');
                    gemElement.classList.add('is-exploding');
                }

                if (gameState.board[r]) gameState.board[r][c] = null;
            }

            updateUI();
            await delay(500);
            return points;
        }

        async function dropGems() {
            const levelConfig = LEVELS[gameState.currentLevel];
            for (let c = 0; c < levelConfig.cols; c++) {
                let emptyRow = null;
                for (let r = levelConfig.rows - 1; r >= 0; r--) {
                    if (gameState.board[r][c] === null && emptyRow === null) emptyRow = r;
                    else if (gameState.board[r][c] !== null && emptyRow !== null) {
                        const gemElement = document.querySelector(`.gem[data-r='${r}'][data-c='${c}']`);
                        if(gemElement) {
                            gemElement.classList.add('gem-fall');
                            gemElement.dataset.r = emptyRow;
                            gemElement.style.top = `${emptyRow * (gemElement.offsetHeight + 4)}px`;
                        }
                        gameState.board[emptyRow][c] = gameState.board[r][c];
                        gameState.board[r][c] = null;
                        emptyRow--;
                    }
                }
            }
            await delay(300);
        }

        async function fillGems() {
            const levelConfig = LEVELS[gameState.currentLevel];
            let madeChange = false;
            for (let r = 0; r < levelConfig.rows; r++) {
                for (let c = 0; c < levelConfig.cols; c++) {
                    if (gameState.board[r][c] === null) {
                        madeChange = true;
                        gameState.board[r][c] = { type: Math.floor(Math.random() * (ICONS.length - 1)), superType: null, isNew: true };
                    }
                }
            }
            if(madeChange) renderBoard();
        }

        function showSuperIconPopup(superType) {
            const popup = document.getElementById('super-icon-popup');
            popup.textContent = SUPER_ICON_MESSAGES[superType];
            popup.style.display = 'block';
            setTimeout(() => { popup.style.display = 'none'; }, 2000);
        }

        function showBonusPopup(message) {
            const popup = document.getElementById('bonus-popup');
            popup.textContent = message;
            popup.style.display = 'block';
            setTimeout(() => { popup.style.display = 'none'; }, 2000);
        }

        function checkGameEnd() {
            if (gameState.isLocked) return;

            const levelConfig = LEVELS[gameState.currentLevel];
            let objectiveMet = false;

            // Determine if the primary objective is met
            if (levelConfig.jellyLayout) {
                // Win if no jelly squares remain.
                const jellyRemaining = gameState.board.flat().some(gem => gem && gem.jelly);
                objectiveMet = !jellyRemaining;
            } else if (levelConfig.collect) {
                // Win if all required items are collected.
                objectiveMet = Object.keys(levelConfig.collect).every(type => {
                    const required = levelConfig.collect[type];
                    const collected = gameState.collected[type] || 0;
                    return collected >= required;
                });
            } else {
                // Default to score objective.
                objectiveMet = gameState.score >= levelConfig.targetScore;
            }

            // If the objective is met, the player wins.
            if (objectiveMet) {
                levelWin();
                return; // Stop further checks
            }

            // If the objective is NOT met, check for loss conditions.
            const isMovesBased = levelConfig.moves !== undefined;
            const isTimeBased = levelConfig.time !== undefined;

            if (isMovesBased && gameState.moves <= 0) {
                levelLose("Ficaste sem jogadas!");
            } else if (isTimeBased && gameState.timer <= 0) {
                // The countdown function also calls this, but this is a safeguard.
                levelLose("Ficaste sem tempo!");
            }
        }

        async function sugarCrush() {
            gameState.isLocked = true;
            const levelConfig = LEVELS[gameState.currentLevel];
            // Use remaining moves, or convert remaining time into "moves"
            const bonusValue = levelConfig.moves !== undefined ? gameState.moves : (gameState.timer > 0 ? Math.floor(gameState.timer / 4) + 3 : 0);

            const gameBoardContainer = document.getElementById('game-board-container');
            if (bonusValue <= 0) {
                showLevelCompleteModal();
                return;
            }

            sounds.sugarCrushStart.triggerAttackRelease(["C4", "G4", "C5", "E5"], "4n");
            showBonusPopup("SUGAR CRUSH!");
            if(gameBoardContainer) gameBoardContainer.classList.add('sugar-crush-active');
            await delay(500);

            const movesDisplay = document.getElementById('game-moves-display');
            const timerDisplay = document.getElementById('game-timer-display');

            for (let i = 0; i < bonusValue; i++) {
                if (gameState.moves > 0) {
                    gameState.moves--;
                    if(movesDisplay) movesDisplay.textContent = gameState.moves;
                } else if (gameState.timer > 0) {
                    gameState.timer = Math.max(0, gameState.timer - 5);
                    if(timerDisplay) timerDisplay.textContent = gameState.timer;
                }

                let randomGemR, randomGemC, gemData;
                let attempts = 0;
                do {
                    randomGemR = Math.floor(Math.random() * levelConfig.rows);
                    randomGemC = Math.floor(Math.random() * levelConfig.cols);
                    gemData = gameState.board[randomGemR]?.[randomGemC];
                    attempts++;
                } while ((!gemData || gemData.superType) && attempts < 50);

                if (!gemData) continue;

                gemData.superType = Math.random() < 0.5 ? 'striped-h' : 'striped-v';
                const gemElement = document.querySelector(`.gem[data-r='${randomGemR}'][data-c='${randomGemC}']`);
                if (gemElement) {
                    gemElement.classList.add(`super-${gemData.superType}`, 'super-gem-creation');
                    setTimeout(() => gemElement.classList.remove('super-gem-creation'), 600);
                }

                sounds.createSuper.triggerAttackRelease('E5', '8n');
                await delay(200);

                const explosionSet = new Set([`${randomGemR}-${randomGemC}`]);
                await activateSuperIcons(explosionSet);

                const pointsFromExplosion = await explodeGems(explosionSet, 2, 100); // Higher chain for more points
                gameState.bonusScore += pointsFromExplosion;

                await processBoardAfterExplosion();

                const newMatches = findMatches();
                if (newMatches.size > 0) {
                    await handleMatches(newMatches, null);
                }
                await delay(400);
            }

            await delay(1000);
            if(gameBoardContainer) gameBoardContainer.classList.remove('sugar-crush-active');
            showLevelCompleteModal();
        }

        async function levelWin() {
            gameState.isLocked = true;
            gameState.levelEndScore = gameState.score;
            gameState.bonusScore = 0;
            endLevelPlaytime();
            clearTimeout(gameState.hintTimer);
            clearInterval(gameState.timerInterval);
            clearTimeout(gameState.autoReshuffleInterval);

            const now = Tone.now();
            sounds.win.triggerAttackRelease(["C4", "E4", "G4", "C5"], "8n", now);
            sounds.win.triggerAttackRelease(["E4", "G4", "C5", "E5"], "8n", now + 0.2);
            sounds.win.triggerAttackRelease(["G4", "C5", "E5", "G5"], "8n", now + 0.4);

            // The "continue" button in the fact modal will now trigger the sugar crush
            document.getElementById('continue-to-score-btn').onclick = () => {
                document.getElementById('sabia-que-modal').style.display = 'none';
                sugarCrush();
            };

            const factModal = document.getElementById('sabia-que-modal');
            const randomFact = ENERGY_FACTS[Math.floor(Math.random() * ENERGY_FACTS.length)];
            document.getElementById('sabia-que-fact').textContent = randomFact;
            factModal.style.display = 'flex';
        }

        async function showLevelCompleteModal() {
            const levelConfig = LEVELS[gameState.currentLevel];
            const character = levelConfig.character;
            const modal = document.getElementById('level-complete-modal');
            const finalScore = gameState.levelEndScore + gameState.bonusScore;

            modal.querySelector('#complete-char-img').src = character.img;
            document.getElementById('level-score-display').textContent = gameState.levelEndScore;
            document.getElementById('bonus-score-display').textContent = gameState.bonusScore;
            document.getElementById('final-score').textContent = finalScore;
            let message = (character.message && levelConfig.isBoss) ? character.message : (character.messages ? character.messages[(levelConfig.level - 1) % 10] : `Mais um passo para derrotar ${character.name}!`);
            modal.querySelector('#complete-char-message').textContent = message;

            modal.style.display = 'flex';

            let stars = 0;
            if (finalScore >= levelConfig.starScores[2]) {
                stars = 3;
            } else if (finalScore >= levelConfig.starScores[1]) {
                stars = 2;
            } else if (finalScore >= levelConfig.starScores[0]) {
                stars = 1;
            }

            const coinsEarned = stars * 10 + (stars > 1 ? (stars > 2 ? 15 : 5) : 0); // 10 for 1, 25 for 2, 50 for 3
            if(coinsEarned > 0) {
                gameState.energyCoins += coinsEarned;
                showBonusPopup(`+${coinsEarned} Moedas!`);
            }

            const starDisplay = document.getElementById('star-display');
            starDisplay.innerHTML = '';
            for (let i = 0; i < 3; i++) {
                const star = document.createElement('span');
                star.innerHTML = i < stars ? '&#9733;' : '&#9734;';
                star.className = `text-4xl ${i < stars ? 'text-yellow-400' : 'text-gray-400'}`;
                starDisplay.appendChild(star);
            }

            if (!gameState.levelStars[gameState.currentLevel] || stars > gameState.levelStars[gameState.currentLevel]) {
                gameState.levelStars[gameState.currentLevel] = stars;
            }

            const oldTotalScore = gameState.totalScore;
            const finalScore = gameState.levelEndScore + gameState.bonusScore;
            gameState.totalScore += finalScore;

            const oldMilestoneLives = Math.floor(oldTotalScore / 10000);
            const newMilestoneLives = Math.floor(gameState.totalScore / 10000);
            const livesEarned = newMilestoneLives - oldMilestoneLives;
            if (livesEarned > 0) {
                gameState.lives += livesEarned;
                showBonusPopup(`+${livesEarned} Vida(s)!`);
            }

            if (gameState.currentLevel === gameState.highestLevel) {
                gameState.highestLevel++;
            }
            if ((gameState.currentLevel + 1) % 10 === 0 && levelConfig.level < 61) {
                gameState.lives++;
            }
            await saveGameData();

            setTimeout(() => {
                modal.style.display = 'none';
                if (levelConfig.level === 61) {
                    showGameCompleteModal();
                } else if (levelConfig.isBoss) {
                    showWorldCompleteModal();
                } else {
                     renderWorldMap(Math.floor(gameState.currentLevel / 10));
                }
            }, 3000);
        }

        async function showWorldCompleteModal() {
            stopMusic();
            const modal = document.getElementById('world-complete-modal');
            const levelConfig = LEVELS[gameState.currentLevel];
            const character = levelConfig.character;
            const worldNumber = Math.floor(levelConfig.level / 10);

            document.getElementById('world-complete-title').textContent = `Mundo ${worldNumber} - ${character.name} Conclu√≠do!`;
            document.getElementById('world-complete-character-name').textContent = character.name;

            let totalSuperIcons = 0;
            if (gameState.stats && gameState.stats.total) {
                let totalStriped = Object.values(gameState.stats.total.striped || {}).reduce((a, b) => a + b, 0);
                totalSuperIcons = totalStriped + (gameState.stats.total.wrapped || 0) + (gameState.stats.total.colorBomb || 0);
            }

            document.getElementById('summary-world-total-score').textContent = gameState.totalScore.toLocaleString();
            document.getElementById('summary-world-play-time').textContent = (gameState.totalPlayTimeMinutes / 60).toFixed(1) + 'h';
            document.getElementById('summary-world-super-icons').textContent = totalSuperIcons.toLocaleString();

            const hofList = document.getElementById('hof-comparison-list');
            hofList.innerHTML = '<li>A carregar ranking...</li>';

            try {
                const leaderboardRef = collection(db, "leaderboard");
                const q = query(leaderboardRef, orderBy("totalScore", "desc"), limit(3));
                const querySnapshot = await getDocs(q);

                let rankHTML = '';
                if (querySnapshot.empty) {
                    rankHTML = '<li>Ainda n√£o h√° ranking. S√™ o primeiro!</li>';
                } else {
                    let rank = 1;
                    querySnapshot.forEach((doc) => {
                        const player = doc.data();
                        const medal = rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : '';
                        rankHTML += `<li class="flex justify-between items-center text-lg"><span>${medal} ${player.name || 'An√≥nimo'}</span><span class="font-bold text-yellow-300">${(player.totalScore || 0).toLocaleString()} pts</span></li>`;
                        rank++;
                    });
                }
                hofList.innerHTML = rankHTML;
            } catch (error) {
                console.error("Erro ao carregar o Hall of Fame para compara√ß√£o:", error);
                hofList.innerHTML = '<li>N√£o foi poss√≠vel carregar o ranking.</li>';
            }

            modal.style.display = 'flex';
        }

        function showGameCompleteModal() {
            stopMusic();
            const modal = document.getElementById('game-complete-modal');

            let totalStriped = 0;
            if (gameState.stats && gameState.stats.total && gameState.stats.total.striped) {
                totalStriped = Object.values(gameState.stats.total.striped).reduce((a, b) => a + b, 0);
            }

            document.getElementById('summary-total-score').textContent = gameState.totalScore.toLocaleString();
            document.getElementById('summary-play-time').textContent = (gameState.totalPlayTimeMinutes / 60).toFixed(1) + 'h';
            document.getElementById('summary-striped').textContent = totalStriped.toLocaleString();
            document.getElementById('summary-wrapped').textContent = (gameState.stats.total.wrapped || 0).toLocaleString();
            document.getElementById('summary-color-bombs').textContent = (gameState.stats.total.colorBomb || 0).toLocaleString();

            modal.style.display = 'flex';

            document.getElementById('back-to-menu-from-complete-btn').addEventListener('click', () => {
                modal.style.display = 'none';
                renderMainMenu(auth.currentUser);
            });
        }

        function levelLose(message = "Ficaste sem jogadas!") {
            gameState.isLocked = true;
            endLevelPlaytime();
            clearTimeout(gameState.hintTimer);
            clearInterval(gameState.timerInterval);
            clearTimeout(gameState.autoReshuffleInterval);

            gameState.lives = Math.max(0, gameState.lives - 1); // Garante que as vidas n√£o ficam negativas
            if (gameState.lives <= 0 && !gameState.livesOutTimestamp) {
                gameState.livesOutTimestamp = Date.now();
            }
            saveGameData();
            updateUI();

            const now = Tone.now();
            sounds.lose.triggerAttackRelease("C4", "4n", now);
            sounds.lose.triggerAttackRelease("A3", "4n", now + 0.1);
            sounds.lose.triggerAttackRelease("F#3", "4n", now + 0.2);
            sounds.lose.triggerAttackRelease("C3", "4n", now + 0.3);

            const modal = document.getElementById('game-over-modal');
            const buttonsContainer = document.getElementById('game-over-buttons');
            buttonsContainer.innerHTML = ''; // Limpar bot√µes antigos

            document.getElementById('game-over-message').textContent = message;

            if (gameState.lives > 0) {
                const retryBtn = document.createElement('button');
                retryBtn.className = 'bg-white text-red-600 font-bold py-3 px-8 rounded-full text-xl transition-transform transform hover:scale-105';
                retryBtn.textContent = 'Tentar Novamente';
                retryBtn.addEventListener('click', () => { document.getElementById('game-over-modal').style.display = 'none'; prepareLevel(); });
                buttonsContainer.appendChild(retryBtn);

                const backBtn = document.createElement('button');
                backBtn.className = 'bg-gray-700 hover:bg-gray-800 text-white font-bold py-2 px-4 rounded-full text-lg';
                backBtn.textContent = 'Voltar ao Mapa';
                backBtn.addEventListener('click', () => {
                    document.getElementById('game-over-modal').style.display = 'none';
                    renderWorldMap(Math.floor(gameState.currentLevel / 10));
                });
                buttonsContainer.appendChild(backBtn);
            } else {
                 document.getElementById('game-over-message').textContent = `Ficaste sem vidas! Ganha mais vidas ou espera 6 horas por cada vida nova (m√°x. 5).`;
                const socialLinks = [
                    { platform: 'tiktok', text: 'TikTok (+5 Vidas)', url: 'https://www.tiktok.com/@koelho2000' },
                    { platform: 'instagram', text: 'Instagram (+5 Vidas)', url: 'https://www.instagram.com/eia_energyinaction/' },
                    { platform: 'youtube', text: 'YouTube (+5 Vidas)', url: 'https://youtube.com/playlist?list=PLHHMjSyJQeBCFjuuPaqrhqMic374sFIkG&si=GimZ3c0V-wMgoMSo' }
                ];

                socialLinks.forEach(link => {
                    const socialBtn = document.createElement('button');
                    socialBtn.className = 'bg-white text-red-600 font-bold py-2 px-4 rounded-full text-lg transition-transform transform hover:scale-105';
                    socialBtn.textContent = link.text;
                    if (gameState.socialClaims[link.platform]) {
                        socialBtn.disabled = true;
                        socialBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    }
                    socialBtn.addEventListener('click', () => {
                        window.open(link.url, '_blank');
                        claimSocialLives(link.platform);
                    });
                    buttonsContainer.appendChild(socialBtn);
                });

                const backBtn = document.createElement('button');
                backBtn.className = 'bg-gray-700 hover:bg-gray-800 text-white font-bold py-2 px-4 rounded-full text-lg';
                backBtn.textContent = 'Voltar ao Mapa';
                backBtn.addEventListener('click', () => {
                    document.getElementById('game-over-modal').style.display = 'none';
                    renderWorldMap(Math.floor(gameState.highestLevel / 10));
                });
                buttonsContainer.appendChild(backBtn);
            }

            setTimeout(() => modal.style.display = 'flex', 500);
        }

        function claimSocialLives(platform) {
            if (gameState.socialClaims[platform]) return;

            gameState.socialClaims[platform] = true;
            let livesAdded = false;

            if (gameState.lives < 5) {
                gameState.lives = Math.min(5, gameState.lives + 5);
                if (gameState.lives >= 5) {
                    gameState.livesOutTimestamp = null;
                }
                livesAdded = true;
            }

            saveGameData(); // Save state regardless

            if (livesAdded) {
                showBonusPopup("+5 Vidas!");
                levelLose("Ganhastes 5 vidas!"); // Rebuild modal with new state
            } else {
                showBonusPopup("J√° tens 5 ou mais vidas!");
                // Rebuild modal to show the button as disabled
                levelLose("J√° tens vidas suficientes!");
            }
        }

        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // --- L√ìGICA DE VERIFICA√á√ÉO DE JOGADAS E DICAS ---

        function clearHints() {
            document.querySelectorAll('.hint').forEach(el => el.classList.remove('hint'));
        }

        function resetHintTimer() {
            clearTimeout(gameState.hintTimer);
            clearHints();
            if (!gameState.isLocked) {
                gameState.hintTimer = setTimeout(showHint, 5000);
            }
        }

        function showHint() {
            const move = findPossibleMove();
            if (move) {
                move.forEach(pos => {
                    const el = document.querySelector(`.gem[data-r='${pos.r}'][data-c='${pos.c}']`);
                    if (el) el.classList.add('hint');
                });
            }
        }

        function findPossibleMove() {
            const levelConfig = LEVELS[gameState.currentLevel];
            for (let r = 0; r < levelConfig.rows; r++) {
                for (let c = 0; c < levelConfig.cols; c++) {
                    if (gameState.board[r][c] && !gameState.board[r][c].isLocked) {
                        if (c < levelConfig.cols - 1 && gameState.board[r][c+1] && !gameState.board[r][c+1].isLocked && wouldMatch(r, c, r, c + 1)) return [{r,c}, {r, c:c+1}];
                        if (r < levelConfig.rows - 1 && gameState.board[r+1][c] && !gameState.board[r+1][c].isLocked && wouldMatch(r, c, r + 1, c)) return [{r,c}, {r:r+1, c}];
                    }
                }
            }
            return null;
        }

        function wouldMatch(r1, c1, r2, c2) {
            if (!gameState.board[r1] || !gameState.board[r1][c1] || !gameState.board[r2] || !gameState.board[r2][c2]) return false;

            const boardCopy = gameState.board.map(row => row.map(gem => (gem ? {...gem} : null)));

            const temp = boardCopy[r1][c1];
            boardCopy[r1][c1] = boardCopy[r2][c2];
            boardCopy[r2][c2] = temp;

            const originalBoard = gameState.board;
            gameState.board = boardCopy;
            const hasMatch = findMatches().size > 0;
            gameState.board = originalBoard;

            return hasMatch;
        }

        function checkForPossibleMoves() {
            return findPossibleMove() !== null;
        }

        async function reshuffleBoard(isSilent = false, isAutomatic = false) {
            gameState.isLocked = true;
            if (isAutomatic) {
                showBonusPopup("A BARALHAR!");
                await delay(1000);
            } else if (!isSilent) {
                showSuperIconPopup("reshuffle");
                await delay(2000);
            }

            const levelConfig = LEVELS[gameState.currentLevel];
            let attempts = 0;
            do {
                // Pega todas as pe√ßas do tabuleiro e baralha-as
                let flatBoard = gameState.board.flat().filter(gem => gem && !gem.isLocked);
                for (let i = flatBoard.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [flatBoard[i], flatBoard[j]] = [flatBoard[j], flatBoard[i]];
                }

                // Coloca as pe√ßas baralhadas de volta no tabuleiro
                let flatIndex = 0;
                for (let r = 0; r < levelConfig.rows; r++) {
                    for (let c = 0; c < levelConfig.cols; c++) {
                        if (gameState.board[r][c] && !gameState.board[r][c].isLocked) {
                            gameState.board[r][c] = flatBoard[flatIndex++];
                        }
                    }
                }
                attempts++;
            } while ((findMatches().size > 0 || !checkForPossibleMoves()) && attempts < 20);

            renderBoard();
            await delay(300);
            const newMatches = findMatches();
            if (newMatches.size > 0) {
                await handleMatches(newMatches, null);
            } else {
                gameState.isLocked = false;
                if (!isSilent) {
                    resetHintTimer();
                }
            }
        }

        // --- DADOS DO JOGO (Firestore / LocalStorage) ---
        async function saveGameData() {
            const user = auth.currentUser;
            const data = {
                lives: gameState.lives,
                highestLevel: gameState.highestLevel,
                livesOutTimestamp: gameState.livesOutTimestamp,
                totalScore: gameState.totalScore,
                levelStars: gameState.levelStars,
                socialClaims: gameState.socialClaims,
                stats: gameState.stats, // Adiciona as estat√≠sticas
                totalPlayTimeMinutes: gameState.totalPlayTimeMinutes,
                energyCoins: gameState.energyCoins
            };
            if (user) {
                const userDocRef = doc(db, "users", user.uid);
                await setDoc(userDocRef, data, { merge: true });

                const leaderboardDocRef = doc(db, "leaderboard", user.uid);
                const leaderboardData = {
                    name: user.displayName,
                    totalScore: gameState.totalScore,
                    highestLevel: gameState.highestLevel + 1, // Mostra o n√≠vel atual, n√£o o √∫ltimo completado
                    stats: gameState.stats, // Adiciona estat√≠sticas ao leaderboard
                    totalPlayTimeMinutes: gameState.totalPlayTimeMinutes
                };
                await setDoc(leaderboardDocRef, leaderboardData, { merge: true });
            } else {
                localStorage.setItem('eiaCrushGuestData', JSON.stringify(data));
            }
        }

        async function loadGameData(userId) {
            const SIX_HOURS = 6 * 60 * 60 * 1000;
            let data;
            if (userId) {
                const userDocRef = doc(db, "users", userId);
                const docSnap = await getDoc(userDocRef);
                if (docSnap.exists()) {
                    data = docSnap.data();
                }
            } else {
                data = JSON.parse(localStorage.getItem('eiaCrushGuestData'));
            }

            if (data) {
                gameState.highestLevel = data.highestLevel || 0;
                gameState.totalScore = data.totalScore || 0;
                gameState.lives = data.lives !== undefined ? data.lives : 5;
                gameState.livesOutTimestamp = data.livesOutTimestamp || null;
                gameState.levelStars = data.levelStars || {};
                gameState.socialClaims = data.socialClaims || { tiktok: false, instagram: false, youtube: false };
                gameState.stats = data.stats || initializeStatsObject(); // Carrega ou inicializa as estat√≠sticas
                gameState.totalPlayTimeMinutes = data.totalPlayTimeMinutes || 0;
                gameState.energyCoins = data.energyCoins || 0;

                if (gameState.lives < 5 && gameState.livesOutTimestamp) {
                    const timePassed = Date.now() - gameState.livesOutTimestamp;
                    const livesGained = Math.floor(timePassed / SIX_HOURS);

                    if (livesGained > 0) {
                        gameState.lives = Math.min(5, gameState.lives + livesGained);
                        if (gameState.lives >= 5) {
                            gameState.livesOutTimestamp = null;
                        } else {
                             gameState.livesOutTimestamp += livesGained * SIX_HOURS;
                        }
                        if(auth.currentUser) await saveGameData();
                    }
                }
            } else {
                resetLocalGameState();
                if (userId) await saveGameData(); // Cria o documento para o novo utilizador
            }

            // Verifica e reinicia as estat√≠sticas peri√≥dicas
            checkAndResetStats();
        }

        function resetLocalGameState() {
            const urlParams = new URLSearchParams(window.location.search);
            const isDebug = urlParams.get('debug') === 'true';

            gameState.currentLevel = 0;
            gameState.score = 0;
            gameState.totalScore = 0;
            gameState.moves = 0;
            gameState.timer = null;
            gameState.board = [];
            gameState.isLocked = true;
            gameState.selectedElement = null;
            gameState.hintTimer = null;
            gameState.lives = 5;
            gameState.highestLevel = 0;
            gameState.livesOutTimestamp = null;
            gameState.levelStars = {};
            gameState.collected = {};
            gameState.socialClaims = { tiktok: false, instagram: false, youtube: false };
            gameState.stats = initializeStatsObject();
            gameState.totalPlayTimeMinutes = 0;
            gameState.energyCoins = isDebug ? 999 : 0;
        }

        // --- L√ìGICA DE ESTAT√çSTICAS ---
        function getStartOfDay(date) {
            return new Date(date.getFullYear(), date.getMonth(), date.getDate()).getTime();
        }

        function getStartOfWeek(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1); // adjust when day is sunday
            return new Date(d.setDate(diff)).setHours(0, 0, 0, 0);
        }

        function getStartOfMonth(date) {
            return new Date(date.getFullYear(), date.getMonth(), 1).getTime();
        }

        function initializeStatsObject() {
            const now = new Date();
            const emptyCounts = {
                striped: { 0:0, 1:0, 2:0, 3:0, 4:0, 5:0 },
                wrapped: 0,
                colorBomb: 0
            };
            return {
                daily: { timestamp: getStartOfDay(now), ...JSON.parse(JSON.stringify(emptyCounts)) },
                weekly: { timestamp: getStartOfWeek(now), ...JSON.parse(JSON.stringify(emptyCounts)) },
                monthly: { timestamp: getStartOfMonth(now), ...JSON.parse(JSON.stringify(emptyCounts)) },
                total: JSON.parse(JSON.stringify(emptyCounts))
            };
        }

        function checkAndResetStats() {
            if (!gameState.stats || !gameState.stats.daily) {
                gameState.stats = initializeStatsObject();
            }
            const now = new Date();
            if (gameState.stats.daily.timestamp !== getStartOfDay(now)) {
                gameState.stats.daily = { timestamp: getStartOfDay(now), ...initializeStatsObject().total };
            }
            if (gameState.stats.weekly.timestamp !== getStartOfWeek(now)) {
                gameState.stats.weekly = { timestamp: getStartOfWeek(now), ...initializeStatsObject().total };
            }
            if (gameState.stats.monthly.timestamp !== getStartOfMonth(now)) {
                gameState.stats.monthly = { timestamp: getStartOfMonth(now), ...initializeStatsObject().total };
            }
        }

        function incrementStat(superType, gemType) {
            if (!auth.currentUser || !gameState.stats) return; // S√≥ regista para utilizadores com login

            let statKey;
            let isStriped = false;
            if (superType.startsWith('striped')) {
                statKey = 'striped';
                isStriped = true;
            } else if (superType === 'wrapped') {
                statKey = 'wrapped';
            } else if (superType === 'color-bomb') {
                statKey = 'colorBomb';
            } else {
                return; // N√£o √© um tipo que queiramos registar
            }

            checkAndResetStats();

            ['daily', 'weekly', 'monthly', 'total'].forEach(period => {
                if (isStriped) {
                    if (!gameState.stats[period][statKey]) gameState.stats[period][statKey] = { 0:0, 1:0, 2:0, 3:0, 4:0, 5:0 };
                    gameState.stats[period][statKey][gemType] = (gameState.stats[period][statKey][gemType] || 0) + 1;
                } else {
                    gameState.stats[period][statKey] = (gameState.stats[period][statKey] || 0) + 1;
                }
            });
        }


        // --- ANIMA√á√ÉO DE PONTOS ---
        function createParticleExplosion(r, c, color) {
            const animationLayer = document.getElementById('animation-layer');
            if (!animationLayer || !gameBoard.firstChild) return;

            const gemSize = gameBoard.firstChild.offsetWidth;
            const gap = 4;
            const top = (r + 0.5) * (gemSize + gap);
            const left = (c + 0.5) * (gemSize + gap);

            for (let i = 0; i < 15; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.backgroundColor = color;

                const angle = Math.random() * Math.PI * 2;
                const distance = Math.random() * (gemSize / 2);
                const duration = 0.5 + Math.random() * 0.4;

                particle.style.top = `${top}px`;
                particle.style.left = `${left}px`;
                particle.style.animationDuration = `${duration}s`;

                // Animate particle movement with JS
                let startTime = null;
                function animateParticle(timestamp) {
                    if (!startTime) startTime = timestamp;
                    const progress = (timestamp - startTime) / (duration * 1000);
                    if (progress > 1) {
                        particle.remove();
                        return;
                    }
                    const currentX = left + Math.cos(angle) * distance * progress * 2;
                    const currentY = top + Math.sin(angle) * distance * progress * 2;
                    particle.style.transform = `translate(${currentX - left}px, ${currentY - top}px) scale(${1-progress})`;
                    requestAnimationFrame(animateParticle);
                }

                animationLayer.appendChild(particle);
                requestAnimationFrame(animateParticle);
            }
        }

        function showPointsAnimation(amount, r, c, isSpecial = false) {
            const gameBoardContainer = document.getElementById('game-board-container');
            if (!gameBoardContainer || !gameBoard.firstChild) return;

            const gemSize = gameBoard.firstChild.offsetWidth;
            const gap = 4; // as defined in CSS .game-board
            const boardPadding = 8; // as defined in CSS .game-board
            const containerPadding = 8; // p-2 in tailwind on game-board-container
            const offset = boardPadding + containerPadding;

            const pointPopup = document.createElement('div');
            pointPopup.textContent = `+${amount}`;
            pointPopup.className = 'point-popup';
            if (isSpecial) {
                pointPopup.classList.add('special');
            }
            // Calculate the position based on the grid, including gaps and paddings
            pointPopup.style.top = `${offset + r * (gemSize + gap)}px`;
            pointPopup.style.left = `${offset + c * (gemSize + gap)}px`;

            gameBoardContainer.appendChild(pointPopup);
            setTimeout(() => pointPopup.remove(), 1000);
        }

        async function animateScore(targetScore) {
            const startScore = gameState.score;
            gameState.score = targetScore;
            const duration = 500;
            let startTime = null;

            function animationStep(timestamp) {
                if (!startTime) startTime = timestamp;
                const progress = Math.min((timestamp - startTime) / duration, 1);
                const currentDisplayScore = Math.floor(progress * (targetScore - startScore) + startScore);
                const scoreDisplay = document.getElementById('game-score-display');
                if (scoreDisplay) scoreDisplay.textContent = currentDisplayScore;
                if (progress < 1) {
                    requestAnimationFrame(animationStep);
                }
            }
            requestAnimationFrame(animationStep);
        }

        async function animateLineClear(row, col, direction) {
            const animationLayer = document.getElementById('animation-layer');
            if (!animationLayer || !gameBoard.firstChild) return;

            const gemSize = gameBoard.firstChild.offsetWidth;
            const gap = 4;
            const line = document.createElement('div');
            line.style.position = 'absolute';
            line.style.backgroundColor = 'white';
            line.style.boxShadow = '0 0 15px 10px rgba(255, 255, 255, 0.7)';
            line.style.zIndex = '15';
            line.style.transition = 'transform 0.3s ease-out, opacity 0.3s ease-out';

            if (direction === 'h') {
                line.style.top = `${(row + 0.5) * (gemSize + gap) - 5}px`;
                line.style.left = '0';
                line.style.width = '100%';
                line.style.height = '10px';
                line.style.transform = 'scaleX(0)';
            } else {
                line.style.left = `${(col + 0.5) * (gemSize + gap) - 5}px`;
                line.style.top = '0';
                line.style.height = '100%';
                line.style.width = '10px';
                line.style.transform = 'scaleY(0)';
            }

            animationLayer.appendChild(line);

            await delay(50); // Short delay to ensure the element is in the DOM before animating
            line.style.transform = 'scaleX(1) scaleY(1)';

            await delay(300);
            line.style.opacity = '0';
            await delay(100);
            line.remove();
        }

        async function animateShockwave(r, c) {
            const animationLayer = document.getElementById('animation-layer');
            if (!animationLayer || !gameBoard.firstChild) return;

            const gemSize = gameBoard.firstChild.offsetWidth;
            const gap = 4;
            const top = (r + 0.5) * (gemSize + gap);
            const left = (c + 0.5) * (gemSize + gap);

            const shockwave = document.createElement('div');
            shockwave.className = 'shockwave';
            shockwave.style.width = `${gemSize * 1.5}px`;
            shockwave.style.height = `${gemSize * 1.5}px`;
            shockwave.style.top = `${top - (gemSize * 0.75)}px`;
            shockwave.style.left = `${left - (gemSize * 0.75)}px`;

            animationLayer.appendChild(shockwave);
            await delay(400);
            shockwave.remove();
        }

        async function animateBoardClear(r, c) {
            const animationLayer = document.getElementById('animation-layer');
            const ripple = document.createElement('div');
            ripple.className = 'board-clear-ripple';

            // Posi√ß√£o da ondula√ß√£o baseada na posi√ß√£o do clique
            const gemSize = gameBoard.firstChild.offsetWidth;
            const gap = 4;
            const top = (r + 0.5) * (gemSize + gap);
            const left = (c + 0.5) * (gemSize + gap);
            ripple.style.top = `${top}px`;
            ripple.style.left = `${left}px`;

            animationLayer.appendChild(ripple);
            await delay(700);
            ripple.remove();
        }

        // --- RENDERIZA√á√ÉO DE ECR√ÉS ---
        function renderMainMenu(user) {
            stopMusic();
            gameBoard = null;
            const template = document.getElementById('main-menu-template');
            appContainer.innerHTML = '';
            appContainer.appendChild(template.content.cloneNode(true));

            const authButtons = document.getElementById('auth-buttons');
            const userInfo = document.getElementById('user-info');

            if (user) {
                authButtons.classList.add('hidden');
                userInfo.classList.remove('hidden');
                document.getElementById('username-display').textContent = user.displayName || user.email;
                document.getElementById('play-map-btn').addEventListener('click', () => renderWorldMap(Math.floor(gameState.highestLevel / 10)));
            } else {
                authButtons.classList.remove('hidden');
                userInfo.classList.add('hidden');
                document.getElementById('login-btn').addEventListener('click', () => { document.getElementById('login-modal').style.display = 'flex'; });
                document.getElementById('register-btn').addEventListener('click', () => { document.getElementById('register-modal').style.display = 'flex'; });
                document.getElementById('guest-play-btn').addEventListener('click', () => {
                    loadGameData(null).then(() => {
                        renderWorldMap(Math.floor(gameState.highestLevel / 10));
                    });
                });
            }
            // L√≥gica dos bot√µes do menu
            document.getElementById('hall-of-fame-btn').addEventListener('click', showHallOfFame);
            document.getElementById('glossary-btn').addEventListener('click', showGlossary);
            document.getElementById('history-btn').addEventListener('click', showHistory);
            updateUI();
        }

        function renderWorldMap(worldIndex = 0) {
            // Adiciona uma verifica√ß√£o para garantir que o worldIndex √© v√°lido
            if (worldIndex >= worldCharacters.length) {
                worldIndex = worldCharacters.length - 1;
            }
            const worldMusic = worldCharacters[worldIndex].music;
            playMusic(worldMusic, 0.3);

            gameBoard = null;
            const template = document.getElementById('world-map-template');
            appContainer.innerHTML = '';
            appContainer.appendChild(template.content.cloneNode(true));
            const worldTabsContainer = document.getElementById('world-tabs');
            const levelGrid = document.getElementById('level-grid');
            const backBtn = document.getElementById('back-to-main-menu-btn');
            const logoutBtn = document.getElementById('logout-btn');
            const unlockBtn = document.getElementById('unlock-btn');
            const finalLevelContainer = document.getElementById('final-level-container');

            backBtn.addEventListener('click', () => renderMainMenu(auth.currentUser));

            if (auth.currentUser) {
                logoutBtn.classList.remove('hidden');
                logoutBtn.addEventListener('click', handleLogout);
                unlockBtn.classList.add('hidden'); // Esconde o bot√£o de desbloquear para utilizadores com login
            } else {
                unlockBtn.classList.remove('hidden'); // Garante que o bot√£o est√° vis√≠vel para convidados
            }

            worldCharacters.forEach((character, index) => {
                const tab = document.createElement('button');
                tab.textContent = `Mundo ${index + 1} - ${character.name}`;
                tab.className = 'world-tab px-4 py-2 rounded-lg font-semibold bg-gray-700 hover:bg-purple-500';
                const firstLevelOfWorld = index * 10;
                if (gameState.highestLevel >= firstLevelOfWorld) {
                    tab.addEventListener('click', () => renderWorldMap(index));
                } else {
                    tab.disabled = true;
                    tab.classList.add('opacity-50', 'cursor-not-allowed');
                }
                if (index === worldIndex) {
                    tab.classList.add('active');
                }
                worldTabsContainer.appendChild(tab);
            });

            levelGrid.innerHTML = '';
            const startLevel = worldIndex * 10;
            const endLevel = startLevel + 10;
            for (let i = startLevel; i < endLevel; i++) {
                const level = LEVELS[i];
                const node = document.createElement('button');
                node.className = 'level-node rounded-full flex items-center justify-center font-bold text-xl';
                node.textContent = level.level;
                node.dataset.levelIndex = i;

                if (i <= gameState.highestLevel) {
                    node.classList.add('unlocked');
                    node.addEventListener('click', async () => {
                        gameState.currentLevel = i;
                        renderGameScreen();
                        await prepareLevel();
                    });

                    if (i < gameState.highestLevel) {
                        node.classList.add('completed');
                        const stars = gameState.levelStars[i] || 0;
                        const starContainer = document.createElement('div');
                        starContainer.className = 'absolute -bottom-3 flex w-full justify-center';
                        for (let j = 0; j < 3; j++) {
                            const starEl = document.createElement('span');
                            starEl.innerHTML = j < stars ? '&#9733;' : '&#9734;';
                            starEl.className = `text-lg ${j < stars ? 'text-yellow-400' : 'text-gray-500'}`;
                            starContainer.appendChild(starEl);
                        }
                        node.appendChild(starContainer);
                    }
                } else {
                    node.disabled = true;
                }
                levelGrid.appendChild(node);
            }

            if (gameState.highestLevel >= 60) {
                const finalLevelBtn = document.createElement('button');
                finalLevelBtn.textContent = 'Desafio Final - N√≠vel 61';
                finalLevelBtn.className = 'mt-4 bg-gradient-to-r from-purple-600 to-red-600 text-white font-bold py-3 px-8 rounded-full text-xl animate-pulse';
                finalLevelBtn.addEventListener('click', () => {
                    playMusic(FINAL_BOSS.music, 0.3);
                    gameState.currentLevel = 60; // Index do n√≠vel 61
                    renderGameScreen();
                    prepareLevel();
                });
                finalLevelContainer.appendChild(finalLevelBtn);
            }

            unlockBtn.addEventListener('click', () => {
                document.getElementById('unlock-modal').style.display = 'flex';
            });
            document.getElementById('world-help-btn').addEventListener('click', () => {
                const modal = document.getElementById('world-help-modal');
                modal.querySelector('#world-help-title').textContent = `Objetivos do Mundo ${worldIndex + 1}`;
                const container = modal.querySelector('#world-help-levels-container');
                container.innerHTML = '';
                for (let i = startLevel; i < endLevel; i++) {
                    const level = LEVELS[i];
                    const levelDiv = document.createElement('div');
                    levelDiv.className = 'p-2 bg-gray-700 rounded';
                    let details = `N√≠vel ${level.level}: ${level.targetScore} pontos`;
                    if(level.time) {
                        details += ` em ${level.time}s`;
                    } else {
                        details += ` em ${level.moves} jogadas`;
                    }
                    levelDiv.textContent = details;
                    container.appendChild(levelDiv);
                }
                modal.style.display = 'flex';
            });
            updateUI();
        }

        function handleUnlockCode() {
            const input = document.getElementById('unlock-code-input');
            const feedback = document.getElementById('unlock-feedback');
            const code = input.value.trim();

            if (code === 'K2000_EIA_CRACK') {
                gameState.highestLevel = LEVELS.length; // Desbloqueia todos os n√≠veis
                saveGameData();
                document.getElementById('unlock-modal').style.display = 'none';
                feedback.textContent = '';
                input.value = '';
                showBonusPopup("Todos os n√≠veis desbloqueados!");
                renderWorldMap(Math.floor(gameState.currentLevel / 10)); // Re-renderiza o mapa
            } else {
                feedback.textContent = 'C√≥digo incorreto!';
                input.value = '';
            }
        }

        function renderGameScreen() {
            const template = document.getElementById('game-screen-template');
            appContainer.innerHTML = '';
            appContainer.appendChild(template.content.cloneNode(true));

            gameBoard = document.getElementById('game-board');

            document.getElementById('quit-level-btn').addEventListener('click', () => {
                clearTimeout(gameState.hintTimer);
                clearInterval(gameState.timerInterval);
                clearTimeout(gameState.autoReshuffleInterval);
                endLevelPlaytime();
                stopMusic();
                renderWorldMap(Math.floor(gameState.currentLevel / 10));
            });

            document.getElementById('help-btn').addEventListener('click', () => {
                document.getElementById('help-modal').style.display = 'flex';
            });

            // Preencher a legenda de √≠cones
            const legendContainer = document.getElementById('icon-legend-container');
            legendContainer.innerHTML = '';

            const heroIconMap = [
                { hero: HEROES[0], icon: ICONS[0] },
                { hero: HEROES[1], icon: ICONS[1] },
                { hero: HEROES[2], icon: ICONS[2] },
            ];
            heroIconMap.forEach(item => {
                const row = document.createElement('div');
                row.className = 'flex items-center gap-4';
                row.innerHTML = `<div class="w-8 h-8">${item.icon}</div> <span>${ICON_NAMES[ICONS.indexOf(item.icon)]} (${item.hero.name})</span>`;
                legendContainer.appendChild(row);
            });
        }

        // --- L√ìGICA DE AUTENTICA√á√ÉO E HALL OF FAME (Firebase) ---
        async function handleRegister() {
            const name = document.getElementById('register-name').value.trim();
            const email = document.getElementById('register-email').value.trim();
            const password = document.getElementById('register-password').value;
            const feedback = document.getElementById('register-feedback');

            if (!name || !email || !password) {
                feedback.textContent = 'Por favor, preencha todos os campos.';
                return;
            }

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                await updateProfile(userCredential.user, { displayName: name });
                // O onAuthStateChanged tratar√° de fazer o login e carregar os dados
                document.getElementById('register-modal').style.display = 'none';
            } catch (error) {
                console.error("Register Error:", error.code);
                if (error.code === 'auth/email-already-in-use') {
                    feedback.textContent = 'Este email j√° est√° registado.';
                } else if (error.code === 'auth/weak-password') {
                    feedback.textContent = 'A palavra-passe deve ter pelo menos 6 caracteres.';
                } else {
                    feedback.textContent = "Erro ao registar. Tente novamente.";
                }
            }
        }

        async function handleLogin() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const feedback = document.getElementById('login-feedback');
            try {
                await signInWithEmailAndPassword(auth, email, password);
                // O onAuthStateChanged tratar√° do resto
                document.getElementById('login-modal').style.display = 'none';
            } catch (error) {
                console.error("Login Error:", error.code);
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                    feedback.textContent = 'Email ou palavra-passe inv√°lidos.';
                } else {
                    feedback.textContent = 'Erro ao fazer login. Tente mais tarde.';
                }
            }
        }

        async function handlePasswordReset() {
            const email = document.getElementById('reset-email').value;
            const feedback = document.getElementById('reset-feedback');
            if (!email) {
                feedback.textContent = 'Por favor, insira o seu email.';
                feedback.classList.add('text-red-500');
                return;
            }
            try {
                await sendPasswordResetEmail(auth, email);
                feedback.textContent = 'Email de recupera√ß√£o enviado!';
                feedback.classList.remove('text-red-500');
                feedback.classList.add('text-green-500');
            } catch (error) {
                feedback.textContent = 'Erro ao enviar o email. Verifique o endere√ßo.';
                feedback.classList.add('text-red-500');
            }
        }

        async function handleLogout() {
            await signOut(auth);
            stopMusic();
            localStorage.removeItem('eiaCrushGuestData');
            // O onAuthStateChanged tratar√° de limpar o estado e renderizar o menu
        }

        async function showHallOfFame() {
            const modal = document.getElementById('hall-of-fame-modal');
            const sidebar = document.getElementById('hof-sidebar');
            modal.style.display = 'flex';
            sidebar.innerHTML = ''; // Limpar separadores anteriores

            const categories = [
                { name: 'Vencedores', field: 'gameCompleted', icon: `<svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M15.5,2.8H14.6V2a1,1,0,0,0-1-1H6.4a1,1,0,0,0-1,1V2.8H4.5A1.5,1.5,0,0,0,3,4.3V6.8A1.5,1.5,0,0,0,4.5,8.3H5V15a3,3,0,0,0,3,3h4a3,3,0,0,0,3-3V8.3h.5A1.5,1.5,0,0,0,17,6.8V4.3A1.5,1.5,0,0,0,15.5,2.8ZM6.4,3h7.2V4.8H6.4ZM14,15a1,1,0,0,1-1,1H7a1,1,0,0,1-1-1V8.3h8Z"/></svg>` },
                { name: 'Pontos', field: 'totalScore', icon: `<svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>` },
                { name: 'N√≠veis', field: 'highestLevel', icon: `<svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3 6a3 3 0 013-3h10a1 1 0 01.8 1.6L14.25 8l2.55 3.4A1 1 0 0116 13H6a1 1 0 00-1 1v3a1 1 0 11-2 0V6z" clip-rule="evenodd"/></svg>` },
                { name: 'Horas de Jogo', field: 'totalPlayTimeMinutes', icon: `<svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.414-1.415L11 9.586V6z" clip-rule="evenodd"/></svg>` },
                { name: 'Pe√ßas Listadas', field: 'stats.total.striped', isSubcategory: true },
                { name: 'Embrulhadas', field: 'stats.total.wrapped', icon: `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-14L4 7m0 0v10l8 4m0-14L4 7"/></svg>` },
                { name: 'Bombas de Cor', field: 'stats.total.colorBomb', icon: `<svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.293 5.293a1 1 0 011.414 0L10 8.586l3.293-3.293a1 1 0 111.414 1.414L11.414 10l3.293 3.293a1 1 0 01-1.414 1.414L10 11.414l-3.293 3.293a1 1 0 01-1.414-1.414L8.586 10 5.293 6.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>` }
            ];

            categories.forEach(cat => {
                if (cat.isSubcategory) {
                    const title = document.createElement('h3');
                    title.className = 'text-lg font-bold text-purple-400 mt-2 px-2';
                    title.textContent = cat.name;
                    sidebar.appendChild(title);
                    ICON_NAMES.forEach((name, index) => {
                        const subcatTab = document.createElement('button');
                        subcatTab.className = 'hof-tab flex items-center gap-2 w-full text-left px-2 py-2 rounded-md hover:bg-purple-500 transition-colors';
                        subcatTab.dataset.field = `${cat.field}.${index}`;
                        subcatTab.innerHTML = `<div class="w-6 h-6 flex-shrink-0">${ICONS[index]}</div><span>${name}</span>`;
                        subcatTab.addEventListener('click', (e) => {
                            document.querySelectorAll('.hof-tab').forEach(t => t.classList.remove('bg-purple-600'));
                            e.currentTarget.classList.add('bg-purple-600');
                            fetchAndDisplayRanking(`${cat.field}.${index}`);
                        });
                        sidebar.appendChild(subcatTab);
                    });
                } else {
                    const tab = document.createElement('button');
                    tab.className = 'hof-tab flex items-center gap-2 w-full text-left px-2 py-2 rounded-md hover:bg-purple-500 transition-colors';
                    tab.dataset.field = cat.field;
                    tab.innerHTML = `<div class="w-6 h-6 flex-shrink-0">${cat.icon}</div><span>${cat.name}</span>`;
                    tab.addEventListener('click', (e) => {
                        document.querySelectorAll('.hof-tab').forEach(t => t.classList.remove('bg-purple-600'));
                        e.currentTarget.classList.add('bg-purple-600');
                        fetchAndDisplayRanking(cat.field);
                    });
                    sidebar.appendChild(tab);
                }
            });

            // Carregar a primeira categoria por defeito
            sidebar.querySelector('.hof-tab').classList.add('bg-purple-600');
            fetchAndDisplayRanking(categories[0].field);
        }

        async function fetchAndDisplayRanking(fieldPath) {
            const content = document.getElementById('hall-of-fame-content');
            const titleEl = document.getElementById('hof-title');
            const tabEl = document.querySelector(`.hof-tab[data-field="${fieldPath}"] span`);
            if (titleEl && tabEl) {
                titleEl.textContent = tabEl.textContent;
            }
            content.innerHTML = '<p class="text-center">A carregar o ranking...</p>';

            try {
                const leaderboardRef = collection(db, "leaderboard");
                 let players = [];

                if (fieldPath === 'gameCompleted') {
                    const q = query(leaderboardRef, where("highestLevel", ">=", 61));
                    const querySnapshot = await getDocs(q);
                    querySnapshot.forEach(doc => players.push(doc.data()));
                    players.sort((a, b) => (b.totalScore || 0) - (a.totalScore || 0));
                    players = players.slice(0, 10);
                } else {
                    const q = query(leaderboardRef, orderBy(fieldPath, "desc"), limit(10));
                    const querySnapshot = await getDocs(q);
                    querySnapshot.forEach(doc => players.push(doc.data()));
                }

                if (players.length === 0) {
                    content.innerHTML = '<p class="text-center">Ainda ningu√©m se classificou nesta categoria.</p>';
                    return;
                }

                let rankHTML = '<ol class="list-decimal list-inside space-y-3">';
                let rank = 1;

                const getNestedValue = (obj, path) => path.split('.').reduce((acc, part) => acc && acc[part], obj);

                players.forEach((player) => {
                    const medal = rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : `#${rank}`;

                    let displayValue;
                    if (fieldPath === 'gameCompleted') {
                         const score = player.totalScore || 0;
                         const time = (player.totalPlayTimeMinutes || 0) / 60;
                         displayValue = `<div class="text-right"><span class="font-bold text-yellow-400">${score.toLocaleString()} pts</span><br><span class="text-xs text-gray-300">${time.toFixed(1)}h</span></div>`;
                    } else {
                        let score = getNestedValue(player, fieldPath) || 0;
                        if (fieldPath === 'totalPlayTimeMinutes') {
                            const hours = (score / 60).toFixed(1);
                            displayValue = `<span class="font-bold text-yellow-400">${hours}h</span>`;
                        } else {
                             displayValue = `<span class="font-bold text-yellow-400">${score.toLocaleString()}</span>`;
                        }
                    }

                    rankHTML += `
                        <li class="p-2 rounded-lg ${rank <= 3 ? 'bg-yellow-800' : 'bg-gray-700'} flex items-center">
                            <span class="font-bold text-lg mr-4 w-10 text-center">${medal}</span>
                            <div class="flex-grow">
                                <span class="text-white text-xl">${player.name || 'An√≥nimo'}</span>
                            </div>
                            ${displayValue}
                        </li>
                    `;
                    rank++;
                });
                rankHTML += '</ol>';
                content.innerHTML = rankHTML;

            } catch (error) {
                console.error(`Erro ao carregar o Hall of Fame para ${fieldPath}:`, error);
                content.innerHTML = '<p class="text-center text-red-500">N√£o foi poss√≠vel carregar o ranking. Tenta mais tarde.</p>';
            }
        }

        function showGlossary() {
            const modal = document.getElementById('glossary-modal');
            const content = document.getElementById('glossary-content');
            content.innerHTML = ''; // Limpa conte√∫do anterior

            ENERGY_GLOSSARY.forEach(item => {
                const entry = document.createElement('div');
                entry.className = 'flex items-start gap-4 p-2 bg-gray-900 rounded-lg';
                entry.innerHTML = `
                    <div class="w-12 h-12 flex-shrink-0">${item.icon}</div>
                    <div>
                        <h3 class="font-bold text-lg text-purple-400">${item.name}</h3>
                        <p class="text-sm text-gray-300">${item.description}</p>
                    </div>
                `;
                content.appendChild(entry);
            });

            modal.style.display = 'flex';
        }

        function showHistory() {
            const modal = document.getElementById('history-modal');
            const content = document.getElementById('history-content');

            const heroesSection = content.querySelector('#heroes-section');
            const villainsSection = content.querySelector('#villains-section');

            heroesSection.innerHTML = '<h3 class="text-2xl font-bold text-green-400 mt-6">Os Her√≥is</h3>';
            villainsSection.innerHTML = '<h3 class="text-2xl font-bold text-red-400 mt-6">Os Vil√µes</h3>';

            HEROES.forEach(hero => {
                const entry = document.createElement('div');
                entry.className = 'flex items-start gap-4 p-2 bg-gray-900 rounded-lg mt-2';
                entry.innerHTML = `
                    <img src="${hero.img}" class="w-16 h-16 rounded-full border-2 border-green-400 flex-shrink-0">
                    <div>
                        <h4 class="font-bold text-lg text-yellow-300">${hero.name}</h4>
                        <p class="text-sm text-gray-300">${hero.description}</p>
                    </div>
                `;
                heroesSection.appendChild(entry);
            });

            VILLAINS.forEach(villain => {
                const entry = document.createElement('div');
                entry.className = 'flex items-start gap-4 p-2 bg-gray-900 rounded-lg mt-2';
                entry.innerHTML = `
                    <img src="${villain.img}" class="w-16 h-16 rounded-full border-2 border-red-400 flex-shrink-0">
                    <div>
                        <h4 class="font-bold text-lg text-yellow-300">${villain.name}</h4>
                        <p class="text-sm text-gray-300">${villain.description}</p>
                    </div>
                `;
                villainsSection.appendChild(entry);
            });

            modal.style.display = 'flex';
        }

        function animateCollect(gemElement) {
            const animationLayer = document.getElementById('animation-layer');
            const objectiveDisplay = document.getElementById('objective-display');
            if (!animationLayer || !objectiveDisplay) return;

            const flyingGem = gemElement.cloneNode(true);
            const startRect = gemElement.getBoundingClientRect();
            const endRect = objectiveDisplay.getBoundingClientRect();

            flyingGem.style.position = 'fixed';
            flyingGem.style.left = `${startRect.left}px`;
            flyingGem.style.top = `${startRect.top}px`;
            flyingGem.style.width = `${startRect.width}px`;
            flyingGem.style.height = `${startRect.height}px`;
            flyingGem.classList.add('collect-fly');

            animationLayer.appendChild(flyingGem);

            // Delay to ensure the element is in the DOM before animating
            setTimeout(() => {
                flyingGem.style.left = `${endRect.left + (endRect.width / 2)}px`;
                flyingGem.style.top = `${endRect.top + (endRect.height / 2)}px`;
                flyingGem.style.transform = 'scale(0.2)';
                flyingGem.style.opacity = '0';
            }, 50);

            setTimeout(() => {
                flyingGem.remove();
                // Optional: add a little flash/pulse on the objective counter
                objectiveDisplay.style.animation = 'pulse-light 0.3s';
                setTimeout(() => objectiveDisplay.style.animation = '', 300);
            }, 550);
        }

        window.onload = () => {
            document.body.addEventListener('click', () => {
                if (Tone.context.state !== 'running') {
                    Tone.start();
                }
            }, { once: true });
            init();
        };

    </script>
</body>
</html>